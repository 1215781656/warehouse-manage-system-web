var K=(R,S,N)=>new Promise((F,w)=>{var V=c=>{try{v(N.next(c))}catch(o){w(o)}},y=c=>{try{v(N.throw(c))}catch(o){w(o)}},v=c=>c.done?F(c.value):Promise.resolve(c.value).then(V,y);v((N=N.apply(R,S)).next())});import{d as X,r as D,a as Z,k as C,l as ee,x as M,F as te,c as A,g as f,b as e,w as t,t as B,T as oe,G as le,e as ae,f as g,z as ne,o as k,h as q,B as ue,q as se,H as ie,I as de,J as re,E as P,_ as me}from"./index-df9e2be5.js";import{f as E}from"./date-70ed563a.js";import{O as ce}from"./OperationBar-90a480f9.js";import{T as pe}from"./TaxInvoiceUpload-5d5a3401.js";import{u as be,R as O}from"./index-a42e7f4e.js";const fe={class:"inbound-add"},_e={class:"page-header"},ge={class:"page-title"},he={class:"item-cards"},Ne={class:"item-card-header"},ve={class:"item-card-title"},Ve={class:"item-row-actions"},ye={class:"total-amount"},we=X({__name:"Add",setup(R){const S=le(),N=ae(),F=be(),w=D(),V=D(!1),y=D(""),v=D(!1),c=D(!1),o=Z({inboundDate:E(new Date),inboundNo:"",supplier:"",items:[]}),Y={inboundDate:[{required:!0,message:"请选择入库日期",trigger:"change"}],inboundNo:[{required:!0,message:"请输入货单编号",trigger:"blur"}],supplier:[{required:!0,message:"请输入供应商",trigger:"blur"}]},b=[{required:!0,message:"此项为必填项",trigger:["blur","change"]}],J=C(()=>(o.items||[]).reduce((l,u)=>l+Number((Number(u.weightKg||0)*Number(u.unitPrice||0)).toFixed(2)),0).toFixed(2)),j=C(()=>"80px"),I=C(()=>V.value&&y.value?`draft:inbound:edit:${y.value}`:"draft:inbound:add"),G=()=>{N.push("/inventory/in")},T=()=>{o.items.push({id:self.crypto.randomUUID(),productSpec:"",composition:"",weight:null,width:null,color:"",colorNo:"",batchNo:"",quantity:null,weightKg:null,unitPrice:null,amountEdited:!1,amount:null,taxAttachments:[]})},H=_=>{const l={id:self.crypto.randomUUID(),productSpec:"",composition:"",weight:null,width:null,color:"",colorNo:"",batchNo:"",quantity:null,weightKg:null,unitPrice:null,amountEdited:!1,amount:null,taxAttachments:[]};o.items.splice(_+1,0,l)},L=_=>{o.items.length!==1&&o.items.splice(_,1)},z=_=>{const l=o.items[_],u=Number(l.weightKg||0),i=Number(l.unitPrice||0);if(!l.amountEdited){const a=parseFloat((u*i).toFixed(2));l.amount=a>0?a:null}},W=()=>K(this,null,function*(){if(!(yield w.value.validate()))return;if(!o.items.length){P.error("请至少添加一条色布明细");return}for(const[u,i]of o.items.entries()){const a=["productSpec","composition","color","colorNo","batchNo"];for(const m of a)if(!i[m]){P.error(`第${u+1}行 ${m} 不能为空`);return}const d=["weight","width","quantity","weightKg","unitPrice"];for(const m of d){const p=i[m];if(p==null||Number.isNaN(Number(p))){P.error(`第${u+1}行 ${m} 需要有效数字`);return}}if(i.amount===null||i.amount===void 0||Number.isNaN(Number(i.amount))){const m=Number(i.weightKg||0),p=Number(i.unitPrice||0);i.amount=Number((m*p).toFixed(2))}}const l={batch:{inboundDate:o.inboundDate,inboundNo:o.inboundNo,supplier:o.supplier,operator:"admin"},items:o.items.map(u=>{var i;return{id:u.id,productSpec:u.productSpec,composition:u.composition,weight:Number(u.weight||0),width:Number(u.width||0),color:u.color,colorNo:u.colorNo,batchNo:u.batchNo,quantity:Number(u.quantity||0),weightKg:Number(u.weightKg||0),unitPrice:Number(u.unitPrice||0),amount:Number((i=u.amount)!=null?i:Number(u.weightKg||0)*Number(u.unitPrice||0)).toFixed(2)}})};c.value=!0,yield M.createInboundBatch(l).finally(()=>{c.value=!1}),P.success("新增成功"),F.invalidate(),localStorage.removeItem(I.value),N.push("/inventory/in")});return ee(()=>K(this,null,function*(){const _=S.query.edit==="1",l=S.query.id||"";if(_&&l){V.value=!0,y.value=l,v.value=!0;const i=yield M.getInboundBatchDetail(l);o.inboundDate=E(i.batch.inboundDate),o.inboundNo=i.batch.inboundNo,o.supplier=i.batch.supplier,o.items=(i.items||[]).map(a=>{var d,m,p,x,h,U,$;return{id:a.id,productSpec:((d=a.colorFabric)==null?void 0:d.productSpec)||"",composition:((m=a.colorFabric)==null?void 0:m.composition)||"",weight:Number(((p=a.colorFabric)==null?void 0:p.weight)||0),width:Number(((x=a.colorFabric)==null?void 0:x.width)||0),color:((h=a.colorFabric)==null?void 0:h.color)||"",colorNo:((U=a.colorFabric)==null?void 0:U.colorNo)||"",batchNo:(($=a.colorFabric)==null?void 0:$.batchNo)||"",quantity:Number(a.quantity||0),weightKg:Number(a.weightKg||0),unitPrice:Number(a.unitPrice||0),amount:Number(a.amount),taxAttachments:a.taxAttachments||[]}}),v.value=!1}else{V.value=!1,y.value="",localStorage.removeItem("draft:inbound:add"),o.inboundDate=E(new Date),o.inboundNo="",o.supplier="",o.items=[],T();return}const u=localStorage.getItem(I.value);u&&Object.assign(o,JSON.parse(u)),o.items.length||T()})),te(o,()=>{localStorage.setItem(I.value,JSON.stringify(o))},{deep:!0}),(_,l)=>{const u=g("el-button"),i=g("el-date-picker"),a=g("el-form-item"),d=g("el-col"),m=g("el-input"),p=g("el-row"),x=g("el-divider"),h=g("el-input-number"),U=g("el-card"),$=g("el-form"),Q=ne("loading");return k(),A("div",fe,[f("div",_e,[e(u,{class:"back-btn",onClick:G},{default:t(()=>[...l[3]||(l[3]=[q("返回",-1)])]),_:1}),f("h1",ge,B(V.value?"编辑入库":"新增入库"),1)]),e(oe,{name:"fade"},{default:t(()=>[f("div",{class:"content-scroll",style:re({paddingBottom:j.value})},[ue((k(),se(U,null,{default:t(()=>[e($,{model:o,rules:Y,ref_key:"formRef",ref:w,"label-width":"100px"},{default:t(()=>[l[6]||(l[6]=f("h3",{class:"section-title"},"批次共用信息",-1)),e(p,{gutter:16},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"入库日期",prop:"inboundDate"},{default:t(()=>[e(i,{modelValue:o.inboundDate,"onUpdate:modelValue":l[0]||(l[0]=n=>o.inboundDate=n),type:"date","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"货单编号",prop:"inboundNo"},{default:t(()=>[e(m,{modelValue:o.inboundNo,"onUpdate:modelValue":l[1]||(l[1]=n=>o.inboundNo=n),placeholder:"请输入货单编号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(p,{gutter:16},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"供应商",prop:"supplier"},{default:t(()=>[e(O,{modelValue:o.supplier,"onUpdate:modelValue":l[2]||(l[2]=n=>o.supplier=n),type:"supplier","allow-create":!0,placeholder:"请输入或选择供应商"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(x),l[7]||(l[7]=f("h3",{class:"section-title"},"色布明细",-1)),f("div",he,[(k(!0),A(ie,null,de(o.items,(n,r)=>(k(),A("div",{class:"item-row",key:n.id||r},[e(U,{class:"item-card",shadow:"hover"},{default:t(()=>[f("div",Ne,[f("div",ve,"色布明细 "+B(r+1),1)]),e(p,{gutter:12},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.productSpec`,rules:b,label:"品名规格"},{default:t(()=>[e(O,{modelValue:n.productSpec,"onUpdate:modelValue":s=>n.productSpec=s,type:"productSpec","allow-create":!0,placeholder:"品名规格"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.composition`,rules:b,label:"成分"},{default:t(()=>[e(O,{modelValue:n.composition,"onUpdate:modelValue":s=>n.composition=s,type:"composition","allow-create":!0,placeholder:"成分"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.weight`,rules:b,label:"克重(g/m²)"},{default:t(()=>[e(h,{modelValue:n.weight,"onUpdate:modelValue":s=>n.weight=s,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.width`,rules:b,label:"全幅宽(cm)"},{default:t(()=>[e(h,{modelValue:n.width,"onUpdate:modelValue":s=>n.width=s,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.color`,rules:b,label:"颜色"},{default:t(()=>[e(m,{modelValue:n.color,"onUpdate:modelValue":s=>n.color=s},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.colorNo`,rules:b,label:"色号"},{default:t(()=>[e(m,{modelValue:n.colorNo,"onUpdate:modelValue":s=>n.colorNo=s},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.batchNo`,rules:b,label:"缸号"},{default:t(()=>[e(m,{modelValue:n.batchNo,"onUpdate:modelValue":s=>n.batchNo=s},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.quantity`,rules:b,label:"匹数"},{default:t(()=>[e(h,{modelValue:n.quantity,"onUpdate:modelValue":s=>n.quantity=s,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.weightKg`,rules:b,label:"重量(kg)"},{default:t(()=>[e(h,{modelValue:n.weightKg,"onUpdate:modelValue":s=>n.weightKg=s,min:.01,precision:2,style:{width:"100%"},onChange:s=>z(r)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.unitPrice`,rules:b,label:"单价(元)"},{default:t(()=>[e(h,{modelValue:n.unitPrice,"onUpdate:modelValue":s=>n.unitPrice=s,min:.01,precision:2,style:{width:"100%"},onChange:s=>z(r)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${r}.amount`,rules:b,label:"金额(元)"},{default:t(()=>[e(h,{modelValue:n.amount,"onUpdate:modelValue":s=>n.amount=s,min:.01,precision:2,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:24},{default:t(()=>[e(a,{label:"附件"},{default:t(()=>[e(pe,{"model-value":n.taxAttachments,"record-type":"inbound","record-id":n.id,"onUpdate:modelValue":s=>n.taxAttachments=s},null,8,["model-value","record-id","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),f("div",Ve,[e(u,{class:"card-action-btn",size:"small",type:"primary","aria-label":"在此卡片下方新增",onClick:s=>H(r)},{default:t(()=>[...l[4]||(l[4]=[q("新增",-1)])]),_:1},8,["onClick"]),e(u,{class:"card-action-btn",size:"small",type:"danger","aria-label":"删除该色布明细",disabled:o.items.length===1,onClick:s=>L(r)},{default:t(()=>[...l[5]||(l[5]=[q("删除",-1)])]),_:1},8,["disabled","onClick"])])]))),128))]),f("div",ye,"总金额：¥ "+B(J.value),1),l[8]||(l[8]=f("div",{class:"form-actions"},null,-1))]),_:1},8,["model"])]),_:1})),[[Q,v.value]])],4)]),_:1}),e(ce,{loading:c.value},{button:t(()=>[e(u,{type:"primary",loading:c.value,onClick:W},{default:t(()=>[...l[9]||(l[9]=[q("提交",-1)])]),_:1},8,["loading"])]),_:1},8,["loading"])])}}});const qe=me(we,[["__scopeId","data-v-3dd32063"]]);export{qe as default};
