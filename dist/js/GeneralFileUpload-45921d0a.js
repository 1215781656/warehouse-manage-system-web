var w=(_,C,m)=>new Promise((n,y)=>{var i=r=>{try{f(m.next(r))}catch(u){y(u)}},o=r=>{try{f(m.throw(r))}catch(u){y(u)}},f=r=>r.done?n(r.value):Promise.resolve(r.value).then(i,o);f((m=m.apply(_,C)).next())});import{d as P,r as g,F as R,f as F,o as v,c as V,b as h,w as x,h as E,g as B,v as I,q as b,H as T,I as $,i as z,j as D,t as L,E as k,M as S,_ as O}from"./index-df9e2be5.js";const q={class:"general-file-upload"},j={key:0,class:"upload-area"},H={class:"file-list"},X={class:"name"},J={class:"actions"},K=".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",Q=P({__name:"GeneralFileUpload",props:{modelValue:{},recordType:{},recordId:{},readonly:{type:Boolean},deferred:{type:Boolean}},emits:["update:modelValue"],setup(_,{expose:C,emit:m}){const n=_,y=m,i=g(),o=g(n.modelValue||[]),f=g([]);R(()=>n.modelValue,e=>{n.deferred||(o.value=e||[])});const r=g(!1),u=g(0),N=e=>{const t=e.originalName;if(t&&typeof t=="string"&&t.trim())return t;const a=(e.path||"").split("/").pop()||"";try{return decodeURIComponent(a)}catch(s){return a}};C({submit:()=>{i.value&&i.value.submit()}});const A=e=>w(this,null,function*(){var s,c,d;const t=e.file,a=20*1024*1024;if(t.size>a){k.error("单文件大小不能超过20MB"),(s=e.onError)==null||s.call(e,new Error("file-too-large"));return}try{r.value=!0,u.value=10;let l;n.recordType==="receivable"?l=yield S.uploadOtherAttachmentsForReceivable(n.recordId,[t]):l=yield S.uploadOtherAttachmentsForPayable(n.recordId,[t]);const p=l.data||l;n.deferred||(o.value=p,y("update:modelValue",p)),k.success("上传成功"),(c=e.onSuccess)==null||c.call(e,l)}catch(l){(d=e.onError)==null||d.call(e,l)}finally{r.value=!1,u.value=0}}),U=e=>w(this,null,function*(){var l,p;if(n.deferred){k.warning("请先保存后再下载");return}const t=o.value.find(M=>M.id===e);if(!t)return;const a=((p=(l=import.meta)==null?void 0:l.env)==null?void 0:p.VITE_FILE_BASE)||"http://localhost:3001",s=(t.path||"").split("/").pop()||"",c=`${a}/files/finance/other/${s}`,d=document.createElement("a");d.href=c,d.download=t.originalName||"附件",d.click()}),G=e=>w(this,null,function*(){var t;if(n.deferred){const a=f.value.findIndex(s=>String(s.id)===String(e));if(a>-1&&f.value.splice(a,1),o.value=o.value.filter(s=>String(s.id)!==String(e)),i.value){const s=(t=i.value.uploadFiles)==null?void 0:t.find(c=>String(c.uid)===String(e));s&&i.value.handleRemove(s)}return}try{yield S.deleteAttachment("other",e),o.value=o.value.filter(a=>a.id!==e),y("update:modelValue",o.value),k.success("删除成功")}catch(a){k.error("删除失败")}});return(e,t)=>{const a=F("el-button"),s=F("el-upload"),c=F("el-progress"),d=F("el-icon");return v(),V("div",q,[_.readonly?I("",!0):(v(),V("div",j,[h(s,{multiple:!0,"file-list":[],"show-file-list":!1,accept:K,"http-request":A,"auto-upload":!0},{default:x(()=>[h(a,{type:"primary"},{default:x(()=>[...t[0]||(t[0]=[E("上传其他附件",-1)])]),_:1}),t[1]||(t[1]=B("div",{class:"el-upload__tip"},"支持 PDF/DOC/XLS 等，单文件 ≤ 20MB",-1))]),_:1})])),r.value?(v(),b(c,{key:1,percentage:u.value,style:{"max-width":"240px"}},null,8,["percentage"])):I("",!0),B("div",H,[(v(!0),V(T,null,$(o.value,l=>(v(),V("div",{key:l.id,class:"file-item"},[h(d,{size:18,class:"icon"},{default:x(()=>[h(z(D))]),_:1}),B("span",X,L(N(l)),1),B("div",J,[h(a,{link:"",type:"primary",onClick:p=>U(l.id)},{default:x(()=>[...t[2]||(t[2]=[E("下载",-1)])]),_:1},8,["onClick"]),_.readonly?I("",!0):(v(),b(a,{key:0,link:"",type:"danger",onClick:p=>G(l.id)},{default:x(()=>[...t[3]||(t[3]=[E("删除",-1)])]),_:1},8,["onClick"]))])]))),128))])])}}});const ee=O(Q,[["__scopeId","data-v-d57e1df9"]]);export{ee as G};
