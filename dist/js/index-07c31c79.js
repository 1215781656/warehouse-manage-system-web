var I=(G,R,h)=>new Promise((W,a)=>{var D=p=>{try{f(h.next(p))}catch(m){a(m)}},C=p=>{try{f(h.throw(p))}catch(m){a(m)}},f=p=>p.done?W(p.value):Promise.resolve(p.value).then(D,C);f((h=h.apply(G,R)).next())});import{d as se,u as pe,a as Q,r as b,k as L,l as me,c as ge,g as T,i as O,q as A,w as c,v as Y,b as l,e as be,x as j,E as w,y as fe,f as v,z as ve,o as k,m as he,h as B,A as _e,t as J,s as Ne,B as ye,C as Se,D as we,_ as ke}from"./index-df9e2be5.js";import{R as Re}from"./ResponsiveActions-187abf65.js";import{E as De}from"./ExportSelectionTable-6f9431bb.js";import{r as X}from"./date-70ed563a.js";import{u as Ce,R as Z}from"./index-a42e7f4e.js";const Ee={class:"outbound"},Fe={class:"page-header"},Ve={class:"header-actions"},ze={class:"pagination-container"},Ie=se({__name:"index",setup(G){const R=be(),h=pe(),W=Ce(),a=Q({dateRange:"",outboundNo:"",deliveryNo:"",customer:"",productSpec:""}),D=b([]),C=b(!1);let f=[];const p=b(),m=b(!1),E=b(0),U=b(!1),_=Q({currentPage:1,pageSize:10,total:0});b(!1),b(!1),b();const N=Q({id:"",outboundDate:new Date,outboundNo:"",deliveryNo:"",colorFabricId:"",customer:"",quantity:0,weightKg:0,unitPrice:0,amount:0,consignee:"",craft:"",customerNote:""});b([]);const F=b(null);L(()=>F.value?`库存: ${F.value.currentStock}匹, 约${(F.value.currentStock*F.value.weight/1e3).toFixed(2)}kg`:"");const P=L(()=>{var t;return((t=F.value)==null?void 0:t.currentStock)||0});L(()=>(N.weightKg*N.unitPrice).toFixed(2)),L(()=>N.colorFabricId&&N.quantity>0&&N.quantity<=P.value&&N.customer&&N.consignee);const q=t=>t.toLocaleString("zh-CN",{minimumFractionDigits:2}),K=()=>{S()},x=()=>{a.dateRange="",a.outboundNo="",a.deliveryNo="",a.customer="",a.productSpec="",S()},S=()=>I(this,null,function*(){C.value=!0;try{const t={};if(a.outboundNo&&(t.outboundNo=a.outboundNo),a.deliveryNo&&(t.deliveryNo=a.deliveryNo),a.customer&&(t.customer=a.customer),a.productSpec&&(t.productSpec=a.productSpec),a.dateRange){const{start:o,end:e}=X(a.dateRange);o&&(t.dateStart=o),e&&(t.dateEnd=e)}const n=yield j.getOutboundList(t);D.value=(n||[]).map(o=>{var e,d,s,u;return{id:o.id,outboundDate:o.outboundDate,outboundNo:o.outboundNo,deliveryNo:o.deliveryNo,customer:o.customer,productSpec:(e=o.colorFabric)==null?void 0:e.productSpec,composition:o.composition||((d=o.colorFabric)==null?void 0:d.composition),color:o.color||((s=o.colorFabric)==null?void 0:s.color),craft:o.process||"",weight:o.gramWeight||((u=o.colorFabric)==null?void 0:u.weight),customerNote:o.customerNote||"",quantity:o.quantity,weightKg:Number(o.weightKg),unitPrice:Number(o.unitPrice),amount:Number(o.amount),consignee:o.consignee,remark:o.remark||""}}),_.total=D.value.length}catch(t){w.error("加载数据失败")}finally{C.value=!1}}),ee=t=>{_.pageSize=t,S()},te=t=>{_.currentPage=t,S()},oe=t=>{R.push({name:"InventoryOutEdit",params:{id:t.id}})},ne=t=>{we.confirm("确定要删除这条出库记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>j.deleteOutbound(t.id).then(()=>{w.success("删除成功"),W.invalidate(),S()}).catch(()=>{w.error("删除失败")}))},ae=t=>{const n=[{label:"详情",onClick:()=>le(t)}];return h.can(o=>o.Inventory.Out.Edit)&&n.push({label:"编辑",onClick:()=>oe(t)}),h.can(o=>o.Inventory.Out.Delete)&&n.push({label:"删除",onClick:()=>ne(t),danger:!0}),n},le=t=>{R.push({name:"InventoryOutDetail",params:{id:t.id}})};me(()=>{S()});const re=()=>{R.push({name:"InventoryOutAdd"})},ie=()=>I(this,null,function*(){var t,n,o;if(!f||f.length===0){w.warning("请勾选数据");return}U.value=!1,m.value=!0,E.value=5;try{const e=(n=(t=p.value)==null?void 0:t.isAllSelected)!=null&&n.call(t)?"Y":"N",d={ids:e==="Y"?null:f,isAll:e,outboundNo:a.outboundNo||void 0,deliveryNo:a.deliveryNo||void 0,customer:a.customer||void 0,productSpec:a.productSpec||void 0,dateStart:a.dateRange&&a.dateRange[0]?a.dateRange[0]:void 0,dateEnd:a.dateRange&&a.dateRange[1]?a.dateRange[1]:void 0},s=yield fe.exportReport("outbound",d,y=>{if(y&&typeof y.loaded=="number"){const i=y.total||0;if(i>0){const $=Math.min(90,Math.max(10,Math.floor(y.loaded/i*90)));E.value=$}}}),u=new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),g=URL.createObjectURL(u),z=document.createElement("a");z.href=g,z.download="出库导出.xlsx",z.click(),URL.revokeObjectURL(g),E.value=100,(o=p.value)==null||o.clearSelection(),w.success("导出成功")}catch(e){U.value=!0,w.error("导出失败")}finally{m.value=!1,setTimeout(()=>{E.value=0,U.value=!1},400)}}),V=new Map;let M=null;const H=t=>{const n={};if(t!=null&&t.outboundNo&&(n.outboundNo=t.outboundNo),t!=null&&t.deliveryNo&&(n.deliveryNo=t.deliveryNo),t!=null&&t.customer&&(n.customer=t.customer),t!=null&&t.productSpec&&(n.productSpec=t.productSpec),t!=null&&t.dateRange){const{start:o,end:e}=X(t.dateRange);o&&(n.dateStart=o),e&&(n.dateEnd=e)}return n},ce=t=>I(this,null,function*(){const o=((yield j.getOutboundList(H(t)))||[]).map(e=>{var d,s,u,g;return{id:e.id,outboundDate:e.outboundDate,outboundNo:e.outboundNo,deliveryNo:e.deliveryNo,customer:e.customer,productSpec:(d=e.colorFabric)==null?void 0:d.productSpec,composition:e.composition||((s=e.colorFabric)==null?void 0:s.composition),color:e.color||((u=e.colorFabric)==null?void 0:u.color),craft:e.process||"",weight:e.gramWeight||((g=e.colorFabric)==null?void 0:g.weight),customerNote:e.customerNote||"",quantity:e.quantity,weightKg:Number(e.weightKg),unitPrice:Number(e.unitPrice),amount:Number(e.amount),consignee:e.consignee,remark:e.remark||""}});M=o,V.clear();for(const e of o)V.set(e.id,e);return o.map(e=>e.id)}),ue=t=>I(this,null,function*(){if(!M){M=((yield j.getOutboundList(H(a)))||[]).map(e=>{var d,s,u,g;return{id:e.id,outboundDate:e.outboundDate,outboundNo:e.outboundNo,deliveryNo:e.deliveryNo,customer:e.customer,productSpec:(d=e.colorFabric)==null?void 0:d.productSpec,composition:e.composition||((s=e.colorFabric)==null?void 0:s.composition),color:e.color||((u=e.colorFabric)==null?void 0:u.color),craft:e.process||"",weight:e.gramWeight||((g=e.colorFabric)==null?void 0:g.weight),quantity:e.quantity,weightKg:Number(e.weightKg),unitPrice:Number(e.unitPrice),amount:Number(e.amount),consignee:e.consignee}}),V.clear();for(const e of M)V.set(e.id,e)}const n=[];for(const o of t){const e=V.get(o);e&&n.push(e)}return n});return(t,n)=>{const o=v("el-icon"),e=v("el-button"),d=v("el-progress"),s=v("el-date-picker"),u=v("el-form-item"),g=v("el-input"),z=v("el-form"),y=v("el-card"),i=v("el-table-column"),$=v("el-pagination"),de=ve("loading");return k(),ge("div",Ee,[T("div",Fe,[n[8]||(n[8]=T("h1",{class:"page-title"},"出库管理",-1)),T("div",Ve,[O(h).can(r=>r.Inventory.Out.Add)?(k(),A(e,{key:0,type:"primary",onClick:re},{default:c(()=>[l(o,null,{default:c(()=>[l(O(he))]),_:1}),n[7]||(n[7]=B(" 新增出库 ",-1))]),_:1})):Y("",!0),m.value?(k(),A(d,{key:1,percentage:E.value,status:U.value?"exception":void 0,style:{width:"160px"}},null,8,["percentage","status"])):Y("",!0),O(h).can(r=>r.Inventory.Out.Export)?(k(),A(e,{key:2,onClick:ie,loading:m.value,disabled:m.value,type:"primary"},{default:c(()=>[m.value?Y("",!0):(k(),A(o,{key:0},{default:c(()=>[l(O(_e))]),_:1})),B(" "+J(m.value?"导出中...":"导出"),1)]),_:1},8,["loading","disabled"])):Y("",!0)])]),l(y,{class:"search-card mb-4 search-bar"},{default:c(()=>[l(z,{inline:!0,model:a,class:"search-form"},{default:c(()=>[l(u,{label:"出货日期"},{default:c(()=>[l(s,{modelValue:a.dateRange,"onUpdate:modelValue":n[0]||(n[0]=r=>a.dateRange=r),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small","value-format":"YYYY-MM-DD",onChange:K},null,8,["modelValue"])]),_:1}),l(u,{label:"货单号"},{default:c(()=>[l(g,{modelValue:a.outboundNo,"onUpdate:modelValue":n[1]||(n[1]=r=>a.outboundNo=r),placeholder:"请输入货单号",size:"small"},null,8,["modelValue"])]),_:1}),l(u,{label:"编号"},{default:c(()=>[l(g,{modelValue:a.deliveryNo,"onUpdate:modelValue":n[2]||(n[2]=r=>a.deliveryNo=r),placeholder:"请输入编号",size:"small"},null,8,["modelValue"])]),_:1}),l(u,{label:"客户"},{default:c(()=>[l(Z,{modelValue:a.customer,"onUpdate:modelValue":[n[3]||(n[3]=r=>a.customer=r),K],type:"customer",placeholder:"请选择客户"},null,8,["modelValue"])]),_:1}),l(u,{label:"品名规格"},{default:c(()=>[l(Z,{modelValue:a.productSpec,"onUpdate:modelValue":[n[4]||(n[4]=r=>a.productSpec=r),K],type:"productSpec",placeholder:"请选择品名规格"},null,8,["modelValue"])]),_:1}),l(u,null,{default:c(()=>[l(e,{type:"primary",onClick:K,size:"small"},{default:c(()=>[l(o,null,{default:c(()=>[l(O(Ne))]),_:1}),n[9]||(n[9]=B(" 搜索 ",-1))]),_:1}),l(e,{onClick:x,size:"small"},{default:c(()=>[...n[10]||(n[10]=[B("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(y,null,{default:c(()=>[ye((k(),A(De,{ref_key:"exportTableRef",ref:p,dataSource:D.value,selectionType:"all",onSelectionChange:r=>Se(f)?f.value=r:f=r,rowKey:"id",storageKey:"outbound-export-selection",queryParams:a,fetchAllIds:ce,fetchItemsByIds:ue},{columns:c(()=>[l(i,{prop:"outboundDate",label:"出货日期",width:"120"}),l(i,{prop:"outboundNo",label:"货单号",width:"150"}),l(i,{prop:"deliveryNo",label:"编号",width:"150"}),l(i,{prop:"customer",label:"客户",width:"120"}),l(i,{prop:"productSpec",label:"品名规格","min-width":"150"}),l(i,{prop:"composition",label:"成分",width:"120"}),l(i,{prop:"color",label:"颜色",width:"80"}),l(i,{prop:"craft",label:"工艺",width:"100"}),l(i,{prop:"weight",label:"克重(g/m²)",width:"100"}),l(i,{prop:"customerNote",label:"客户备注",width:"100"}),l(i,{prop:"quantity",label:"匹数",width:"80"}),l(i,{prop:"weightKg",label:"重量(kg)",width:"100"}),l(i,{prop:"unitPrice",label:"单价(元)",width:"100"}),l(i,{prop:"amount",label:"金额(元)",width:"120"},{default:c(({row:r})=>[B(" ¥"+J(q(r.amount)),1)]),_:1}),l(i,{prop:"consignee",label:"签收人",width:"100"}),l(i,{prop:"remark",label:"备注",width:"120"}),l(i,{label:"操作",width:"160",fixed:"right"},{default:c(({row:r})=>[l(Re,{items:ae(r)},null,8,["items"])]),_:1})]),_:1},8,["dataSource","onSelectionChange","queryParams"])),[[de,C.value]]),T("div",ze,[l($,{"current-page":_.currentPage,"onUpdate:currentPage":n[5]||(n[5]=r=>_.currentPage=r),"page-size":_.pageSize,"onUpdate:pageSize":n[6]||(n[6]=r=>_.pageSize=r),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ee,onCurrentChange:te},null,8,["current-page","page-size","total"])])]),_:1})])}}});const Le=ke(Ie,[["__scopeId","data-v-abec1c98"]]);export{Le as default};
