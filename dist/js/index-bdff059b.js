var y=(H,B,l)=>new Promise((N,W)=>{var k=h=>{try{_(l.next(h))}catch(x){W(x)}},C=h=>{try{_(l.throw(h))}catch(x){W(x)}},_=h=>h.done?N(h.value):Promise.resolve(h.value).then(k,C);_((l=l.apply(H,B)).next())});import{d as uo,u as po,a as j,r as v,l as so,c as X,g as U,q as R,v as A,i as K,w as c,b as e,x as Y,E as O,y as ho,f as u,z as bo,o as z,A as go,h as m,t as S,s as fo,B as _o,C as mo,_ as wo}from"./index-df9e2be5.js";import{E as vo}from"./ExportSelectionTable-6f9431bb.js";import{u as So,R as Z}from"./index-a42e7f4e.js";const No={class:"stock"},ko={class:"page-header"},xo={class:"header-actions"},Vo={class:"pagination-container"},Qo={key:0},Wo=uo({__name:"index",setup(H){const B=po();So();const l=j({productSpec:"",composition:"",weight:null,width:null,color:"",colorNo:""}),N=v([]),W=v(!1);let k=[];const C=v(),_=v(!1),h=v(0),x=v(!1),V=j({currentPage:1,pageSize:10,total:0}),G=v(!1),Q=v(null),$=v([]),L=j({totalTypes:0,totalQuantity:0,totalWeight:0}),T=o=>y(this,null,function*(){W.value=!0;try{const i=yield Y.getStockList(o||{});N.value=(i||[]).map(n=>{var t,p,r,b,g,f,s;return{id:n.id,colorNo:(t=n.colorFabric)==null?void 0:t.colorNo,productSpec:(p=n.colorFabric)==null?void 0:p.productSpec,composition:(r=n.colorFabric)==null?void 0:r.composition,weight:(b=n.colorFabric)==null?void 0:b.weight,width:(g=n.colorFabric)==null?void 0:g.width,color:(f=n.colorFabric)==null?void 0:f.color,batchNo:(s=n.colorFabric)==null?void 0:s.batchNo,inboundQuantity:n.totalInboundQuantity,inboundWeight:Number(n.totalInboundWeight),outboundQuantity:n.totalOutboundQuantity,outboundWeight:Number(n.totalOutboundWeight),currentQuantity:n.currentQuantity,currentWeight:Number(n.currentWeight)}}),L.totalTypes=N.value.length,L.totalQuantity=N.value.reduce((n,t)=>n+t.currentQuantity,0),L.totalWeight=N.value.reduce((n,t)=>n+t.currentWeight,0),V.total=N.value.length}catch(i){O.error("加载数据失败")}finally{W.value=!1}}),D=()=>{const o={};l.productSpec&&(o.productSpec=l.productSpec),l.composition&&(o.composition=l.composition),l.weight!==null&&l.weight!==void 0&&l.weight!==""&&(o.weight=l.weight),l.width!==null&&l.width!==void 0&&l.width!==""&&(o.width=l.width),l.color&&(o.color=l.color),l.colorNo&&(o.colorNo=l.colorNo),T(o)},P=()=>{l.productSpec="",l.composition="",l.weight=null,l.width=null,l.color="",l.colorNo="",T({})},q=o=>{V.pageSize=o},oo=o=>{V.currentPage=o},to=()=>y(this,null,function*(){var o,i,n,t,p;if(!k||k.length===0){O.warning("请勾选数据");return}x.value=!1,_.value=!0,h.value=5;try{const r=(i=(o=C.value)==null?void 0:o.isAllSelected)!=null&&i.call(o)?"Y":"N",b={ids:r==="Y"?null:k,isAll:r,productSpec:l.productSpec||void 0,composition:l.composition||void 0,weight:(n=l.weight)!=null?n:void 0,width:(t=l.width)!=null?t:void 0,color:l.color||void 0,colorNo:l.colorNo||void 0},g=yield ho.exportReport("stock",b,F=>{if(F&&typeof F.loaded=="number"){const w=F.total||0;if(w>0){const M=Math.min(90,Math.max(10,Math.floor(F.loaded/w*90)));h.value=M}}}),f=new Blob([g],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),s=URL.createObjectURL(f),a=document.createElement("a");a.href=s,a.download="库存导出.xlsx",a.click(),URL.revokeObjectURL(s),h.value=100,(p=C.value)==null||p.clearSelection(),O.success("导出成功")}catch(r){x.value=!0,O.error("导出失败")}finally{_.value=!1,setTimeout(()=>{h.value=0,x.value=!1},400)}}),I=new Map;let E=null;const J=o=>{const i={};return o!=null&&o.productSpec&&(i.productSpec=o.productSpec),o!=null&&o.composition&&(i.composition=o.composition),(o==null?void 0:o.weight)!==null&&(o==null?void 0:o.weight)!==void 0&&(o==null?void 0:o.weight)!==""&&(i.weight=o.weight),(o==null?void 0:o.width)!==null&&(o==null?void 0:o.width)!==void 0&&(o==null?void 0:o.width)!==""&&(i.width=o.width),o!=null&&o.color&&(i.color=o.color),o!=null&&o.colorNo&&(i.colorNo=o.colorNo),i},eo=o=>y(this,null,function*(){const n=((yield Y.getStockList(J(o)))||[]).map(t=>{var p,r,b,g,f,s,a;return{id:t.id,colorNo:(p=t.colorFabric)==null?void 0:p.colorNo,productSpec:(r=t.colorFabric)==null?void 0:r.productSpec,composition:(b=t.colorFabric)==null?void 0:b.composition,weight:(g=t.colorFabric)==null?void 0:g.weight,width:(f=t.colorFabric)==null?void 0:f.width,color:(s=t.colorFabric)==null?void 0:s.color,batchNo:(a=t.colorFabric)==null?void 0:a.batchNo,inboundQuantity:t.totalInboundQuantity,inboundWeight:Number(t.totalInboundWeight),outboundQuantity:t.totalOutboundQuantity,outboundWeight:Number(t.totalOutboundWeight),currentQuantity:t.currentQuantity,currentWeight:Number(t.currentWeight)}});E=n,I.clear();for(const t of n)I.set(t.id,t);return n.map(t=>t.id)}),lo=o=>y(this,null,function*(){if(!E){E=((yield Y.getStockList(J(l)))||[]).map(t=>{var p,r,b,g,f,s,a;return{id:t.id,colorNo:(p=t.colorFabric)==null?void 0:p.colorNo,productSpec:(r=t.colorFabric)==null?void 0:r.productSpec,composition:(b=t.colorFabric)==null?void 0:b.composition,weight:(g=t.colorFabric)==null?void 0:g.weight,width:(f=t.colorFabric)==null?void 0:f.width,color:(s=t.colorFabric)==null?void 0:s.color,batchNo:(a=t.colorFabric)==null?void 0:a.batchNo,inboundQuantity:t.totalInboundQuantity,inboundWeight:Number(t.totalInboundWeight),outboundQuantity:t.totalOutboundQuantity,outboundWeight:Number(t.totalOutboundWeight),currentQuantity:t.currentQuantity,currentWeight:Number(t.currentWeight)}}),I.clear();for(const t of E)I.set(t.id,t)}const i=[];for(const n of o){const t=I.get(n);t&&i.push(t)}return i});return so(()=>{T()}),(o,i)=>{const n=u("el-progress"),t=u("el-icon"),p=u("el-button"),r=u("el-form-item"),b=u("el-input-number"),g=u("el-input"),f=u("el-form"),s=u("el-card"),a=u("el-table-column"),F=u("el-pagination"),w=u("el-descriptions-item"),M=u("el-descriptions"),io=u("el-divider"),no=u("el-tag"),co=u("el-table"),ao=u("el-dialog"),ro=bo("loading");return z(),X("div",No,[U("div",ko,[i[9]||(i[9]=U("h1",{class:"page-title"},"库存查询",-1)),U("div",xo,[_.value?(z(),R(n,{key:0,percentage:h.value,status:x.value?"exception":void 0,style:{width:"160px"}},null,8,["percentage","status"])):A("",!0),K(B).can(d=>d.Inventory.Stock.Export)?(z(),R(p,{key:1,onClick:to,loading:_.value,disabled:_.value,type:"primary"},{default:c(()=>[_.value?A("",!0):(z(),R(t,{key:0},{default:c(()=>[e(K(go))]),_:1})),m(" "+S(_.value?"导出中...":"导出"),1)]),_:1},8,["loading","disabled"])):A("",!0)])]),e(s,{class:"search-card mb-4 search-bar"},{default:c(()=>[e(f,{inline:!0,model:l,class:"search-form"},{default:c(()=>[e(r,{label:"品名规格"},{default:c(()=>[e(Z,{modelValue:l.productSpec,"onUpdate:modelValue":[i[0]||(i[0]=d=>l.productSpec=d),D],type:"productSpec",placeholder:"请选择品名规格"},null,8,["modelValue"])]),_:1}),e(r,{label:"成分"},{default:c(()=>[e(Z,{modelValue:l.composition,"onUpdate:modelValue":[i[1]||(i[1]=d=>l.composition=d),D],type:"composition",placeholder:"请选择成分"},null,8,["modelValue"])]),_:1}),e(r,{label:"克重"},{default:c(()=>[e(b,{modelValue:l.weight,"onUpdate:modelValue":i[2]||(i[2]=d=>l.weight=d),min:0,size:"small","controls-position":"right"},null,8,["modelValue"])]),_:1}),e(r,{label:"全幅"},{default:c(()=>[e(b,{modelValue:l.width,"onUpdate:modelValue":i[3]||(i[3]=d=>l.width=d),min:0,size:"small","controls-position":"right"},null,8,["modelValue"])]),_:1}),e(r,{label:"颜色"},{default:c(()=>[e(g,{modelValue:l.color,"onUpdate:modelValue":i[4]||(i[4]=d=>l.color=d),placeholder:"请输入颜色",size:"small"},null,8,["modelValue"])]),_:1}),e(r,{label:"色号"},{default:c(()=>[e(g,{modelValue:l.colorNo,"onUpdate:modelValue":i[5]||(i[5]=d=>l.colorNo=d),placeholder:"请输入色号",size:"small"},null,8,["modelValue"])]),_:1}),e(r,null,{default:c(()=>[e(p,{type:"primary",onClick:D,size:"small"},{default:c(()=>[e(t,null,{default:c(()=>[e(K(fo))]),_:1}),i[10]||(i[10]=m(" 搜索 ",-1))]),_:1}),e(p,{onClick:P,size:"small"},{default:c(()=>[...i[11]||(i[11]=[m("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(s,null,{default:c(()=>[_o((z(),R(vo,{ref_key:"exportTableRef",ref:C,dataSource:N.value,selectionType:"all",onSelectionChange:d=>mo(k)?k.value=d:k=d,rowKey:"id",storageKey:"stock-export-selection",queryParams:l,fetchAllIds:eo,fetchItemsByIds:lo},{columns:c(()=>[e(a,{prop:"productSpec",label:"品名规格","min-width":"150"}),e(a,{prop:"composition",label:"成分",width:"100"}),e(a,{prop:"weight",label:"克重(g/m²)",width:"100"}),e(a,{prop:"width",label:"全幅宽(cm)",width:"100"}),e(a,{prop:"color",label:"颜色",width:"100"}),e(a,{prop:"colorNo",label:"色号",width:"100"}),e(a,{prop:"inboundQuantity",label:"入库匹数",width:"120"}),e(a,{prop:"inboundWeight",label:"入库重量(kg)",width:"140"}),e(a,{prop:"outboundQuantity",label:"出库匹数",width:"120"}),e(a,{prop:"outboundWeight",label:"出库重量(kg)",width:"140"}),e(a,{prop:"currentQuantity",label:"库存匹数",width:"120"}),e(a,{prop:"currentWeight",label:"库存重量(kg)",width:"140"})]),_:1},8,["dataSource","onSelectionChange","queryParams"])),[[ro,W.value]]),U("div",Vo,[e(F,{"current-page":V.currentPage,"onUpdate:currentPage":i[6]||(i[6]=d=>V.currentPage=d),"page-size":V.pageSize,"onUpdate:pageSize":i[7]||(i[7]=d=>V.pageSize=d),"page-sizes":[10,20,50,100],total:V.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:q,onCurrentChange:oo},null,8,["current-page","page-size","total"])])]),_:1}),e(ao,{modelValue:G.value,"onUpdate:modelValue":i[8]||(i[8]=d=>G.value=d),title:"库存详情",width:"600px"},{default:c(()=>[Q.value?(z(),X("div",Qo,[e(M,{column:2,border:""},{default:c(()=>[e(w,{label:"色号"},{default:c(()=>[m(S(Q.value.colorNo),1)]),_:1}),e(w,{label:"品名规格"},{default:c(()=>[m(S(Q.value.productSpec),1)]),_:1}),e(w,{label:"成分"},{default:c(()=>[m(S(Q.value.composition),1)]),_:1}),e(w,{label:"克重"},{default:c(()=>[m(S(Q.value.weight)+" g/m²",1)]),_:1}),e(w,{label:"全幅宽"},{default:c(()=>[m(S(Q.value.width)+" cm",1)]),_:1}),e(w,{label:"颜色"},{default:c(()=>[m(S(Q.value.color),1)]),_:1}),e(w,{label:"缸号"},{default:c(()=>[m(S(Q.value.batchNo),1)]),_:1})]),_:1}),e(io),i[12]||(i[12]=U("h4",null,"库存变动记录",-1)),e(co,{data:$.value,style:{width:"100%"},"max-height":"300"},{default:c(()=>[e(a,{prop:"date",label:"日期",width:"120"}),e(a,{prop:"type",label:"类型",width:"80"},{default:c(({row:d})=>[e(no,{type:d.type==="in"?"success":"danger",size:"small"},{default:c(()=>[m(S(d.type==="in"?"入库":"出库"),1)]),_:2},1032,["type"])]),_:1}),e(a,{prop:"quantity",label:"数量(匹)",width:"100"}),e(a,{prop:"weight",label:"重量(kg)",width:"100"}),e(a,{prop:"note",label:"备注"})]),_:1},8,["data"])])):A("",!0)]),_:1},8,["modelValue"])])}}});const yo=wo(Wo,[["__scopeId","data-v-71921fc0"]]);export{yo as default};
