var C=(Z,U,o)=>new Promise((K,O)=>{var I=h=>{try{A(o.next(h))}catch(z){O(z)}},N=h=>{try{A(o.throw(h))}catch(z){O(z)}},A=h=>h.done?K(h.value):Promise.resolve(h.value).then(I,N);A((o=o.apply(Z,U)).next())});import{d as Re,u as he,a as $,r as S,l as ye,c as Ae,g as s,i as Y,q as j,w as n,v as H,b as t,t as _,e as we,L as J,E as D,y as xe,f as p,z as Se,o as F,h as R,A as De,s as ke,B as Ie,n as ze,C as Ve,M as X,D as Ce,_ as Ue}from"./index-df9e2be5.js";import{R as Te}from"./ResponsiveActions-187abf65.js";import{T as Oe}from"./TaxInvoiceUpload-5d5a3401.js";import{G as Ee}from"./GeneralFileUpload-45921d0a.js";import{E as Fe}from"./ExportSelectionTable-6f9431bb.js";const Ne={class:"receivable"},Be={class:"page-header"},Le={class:"header-actions"},Me={class:"data-card"},$e={class:"data-card-value"},je={class:"data-card"},Ke={class:"data-card-value"},Ge={class:"data-card-trend"},Ye={class:"trend-up"},He={class:"data-card"},Je={class:"data-card-value",style:{color:"#ff4d4f"}},Qe={class:"data-card-trend"},We={class:"pagination-container"},Xe={class:"summary-bar"},Ze={class:"summary-bar__items"},Pe={class:"summary-bar__item"},qe={class:"summary-bar__value"},et={class:"summary-bar__item"},tt={class:"summary-bar__value"},at={class:"summary-bar__item"},lt={class:"summary-bar__value summary-bar__value--danger"},nt={class:"dialog-footer"},ot=Re({__name:"index",setup(Z){const U=he(),o=$({customer:"",dateRange:[]}),K=S([]),O=S(!1);S([]);let I=[];const N=S(),A=S(!1),h=S(0),z=S(!1),w=$({currentPage:1,pageSize:10,total:0}),v=$({totalReceivable:0,totalReceived:0,totalUnpaid:0,receivedPercent:0,unpaidPercent:0}),m=$({totalReceivable:0,totalReceived:0,totalUnpaid:0,receivedPercent:0,unpaidPercent:0}),B=S(!1),x=S(null),P=S(),Q=we(),c=$({amount:null,remark:"",taxInvoiceAmount:null,taxAttachments:[],otherAttachments:[]}),ae={amount:[{required:!0,message:"请输入收款金额",trigger:"blur"}]},g=a=>a.toLocaleString("zh-CN",{minimumFractionDigits:2}),q=()=>{T()},le=()=>{o.customer="",o.dateRange=[],T()},T=()=>C(this,null,function*(){var a,e;O.value=!0;try{const r={page:w.currentPage,pageSize:w.pageSize,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(new Date(o.dateRange[0]).getTime()-new Date(o.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(new Date(o.dateRange[1]).getTime()-new Date(o.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},i=yield J().fetchReceivableList(r),u=(i==null?void 0:i.list)||[],k=(i==null?void 0:i.total)||0;K.value=u,w.total=k;const y=((a=i==null?void 0:i.summary)==null?void 0:a.receivable)||{};v.totalReceivable=y.totalReceivable||0,v.totalReceived=y.totalReceived||0,v.totalUnpaid=y.totalUnpaid||0,v.receivedPercent=v.totalReceivable?Number((v.totalReceived/v.totalReceivable*100).toFixed(1)):0,v.unpaidPercent=v.totalReceivable?Number((v.totalUnpaid/v.totalReceivable*100).toFixed(1)):0;const d=((e=i==null?void 0:i.globalSummary)==null?void 0:e.receivable)||{};d&&Object.keys(d).length&&(m.totalReceivable=d.totalReceivable||0,m.totalReceived=d.totalReceived||0,m.totalUnpaid=d.totalUnpaid||0,m.receivedPercent=m.totalReceivable?Number((m.totalReceived/m.totalReceivable*100).toFixed(1)):0,m.unpaidPercent=m.totalReceivable?Number((m.totalUnpaid/m.totalReceivable*100).toFixed(1)):0)}catch(r){D.error("加载数据失败")}finally{O.value=!1}}),ne=a=>{w.pageSize=a,T()},oe=a=>{w.currentPage=a,T()},se=()=>{Q.push("/finance/receivable/add")},ie=a=>C(this,null,function*(){x.value=a;try{const e=yield X.getReceivableDetail(a.id);if(((e==null?void 0:e.unpaidAmount)||0)<=0){D.warning("该记录已全部收款，无需再次收款");return}c.amount=e==null?void 0:e.unpaidAmount,c.remark="",c.taxInvoiceAmount=e==null?void 0:e.taxInvoiceAmount,c.taxAttachments=(e==null?void 0:e.taxAttachments)||[],c.otherAttachments=(e==null?void 0:e.otherAttachments)||[],B.value=!0}catch(e){D.error("获取详情失败")}}),re=a=>{Q.push(`/finance/receivable/edit/${a.id}`)},de=()=>{P.value.validate(a=>{a&&C(this,null,function*(){try{yield X.updateReceivable(x.value.id,{receivedAmount:Number(x.value.receivedAmount||0)+Number(c.amount||0),taxInvoiceAmount:c.taxInvoiceAmount,remark:c.remark||void 0}),D.success(`收款成功：¥${g(c.amount)}`),B.value=!1,T()}catch(e){D.error("收款提交失败")}})})},ce=a=>{Ce.confirm("确定要删除该记录吗？该操作为软删除。","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>C(this,null,function*(){try{yield X.updateReceivable(a.id,{deletedAt:new Date().toISOString()}),J().logOperation("receivable","soft_delete",a.id),D.success("删除成功"),T()}catch(e){D.error("删除失败")}}))},ue=a=>!a.source||a.source==="manual",me=a=>{const e=[];return e.push({label:"详情",onClick:()=>Q.push(`/finance/receivable/detail/${a.id}`)}),U.can(r=>r.Finance.Receivable.Payment)&&e.push({label:"收款",onClick:()=>ie(a)}),ue(a)&&(U.can(r=>r.Finance.Receivable.Edit)&&e.push({label:"编辑",onClick:()=>re(a)}),U.can(r=>r.Finance.Receivable.Delete)&&e.push({label:"删除",onClick:()=>ce(a),danger:!0})),e},pe=()=>C(this,null,function*(){var a,e,r;if(!I||I.length===0){D.warning("请勾选数据");return}z.value=!1,A.value=!0,h.value=5;try{const f=(e=(a=N.value)==null?void 0:a.isAllSelected)!=null&&e.call(a)?"Y":"N",i={ids:f==="Y"?null:I,isAll:f,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(o.dateRange[0]).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(o.dateRange[1]).toISOString().substring(0,10):void 0},u=yield xe.exportReport("receivable",i,E=>{if(E&&typeof E.loaded=="number"){const M=E.total||0;if(M>0){const G=Math.min(90,Math.max(10,Math.floor(E.loaded/M*90)));h.value=G}}}),k=new Blob([u],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),y=URL.createObjectURL(k),d=document.createElement("a");d.href=y,d.download="应收导出.xlsx",d.click(),URL.revokeObjectURL(y),h.value=100,(r=N.value)==null||r.clearSelection(),D.success("导出成功")}catch(f){z.value=!0,D.error("导出失败")}finally{A.value=!1,setTimeout(()=>{h.value=0,z.value=!1},400)}}),L=new Map;let W=null;const ve=a=>C(this,null,function*(){const e={page:1,pageSize:1e5,customer:(a==null?void 0:a.customer)||void 0,startDate:Array.isArray(a==null?void 0:a.dateRange)&&(a!=null&&a.dateRange[0])?new Date(new Date(a.dateRange[0]).getTime()-new Date(a.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(a==null?void 0:a.dateRange)&&(a!=null&&a.dateRange[1])?new Date(new Date(a.dateRange[1]).getTime()-new Date(a.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},f=yield J().fetchReceivableList(e),i=(f==null?void 0:f.list)||[];W=i,L.clear();for(const u of i)L.set(u.id,u);return i.map(u=>u.id)}),ge=a=>C(this,null,function*(){if(!W){const r={page:1,pageSize:1e5,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(new Date(o.dateRange[0]).getTime()-new Date(o.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(new Date(o.dateRange[1]).getTime()-new Date(o.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},i=yield J().fetchReceivableList(r),u=(i==null?void 0:i.list)||[];W=u,L.clear();for(const k of u)L.set(k.id,k)}const e=[];for(const r of a){const f=L.get(r);f&&e.push(f)}return e});return ye(()=>{T()}),(a,e)=>{const r=p("el-button"),f=p("el-progress"),i=p("el-icon"),u=p("el-col"),k=p("el-row"),y=p("el-input"),d=p("el-form-item"),E=p("el-date-picker"),M=p("el-form"),G=p("el-card"),b=p("el-table-column"),fe=p("el-pagination"),ee=p("el-divider"),te=p("el-input-number"),be=p("el-dialog"),_e=Se("loading");return F(),Ae("div",Ne,[s("div",Be,[e[12]||(e[12]=s("h1",{class:"page-title"},"应收管理",-1)),s("div",Le,[Y(U).can(l=>l.Finance.Receivable.Add)?(F(),j(r,{key:0,type:"primary",onClick:se},{default:n(()=>[...e[11]||(e[11]=[R("新增",-1)])]),_:1})):H("",!0),A.value?(F(),j(f,{key:1,percentage:h.value,status:z.value?"exception":void 0,style:{width:"160px"}},null,8,["percentage","status"])):H("",!0),Y(U).can(l=>l.Finance.Receivable.Export)?(F(),j(r,{key:2,onClick:pe,loading:A.value,disabled:A.value,type:"primary"},{default:n(()=>[A.value?H("",!0):(F(),j(i,{key:0},{default:n(()=>[t(Y(De))]),_:1})),R(" "+_(A.value?"导出中...":"导出"),1)]),_:1},8,["loading","disabled"])):H("",!0)])]),t(k,{gutter:16,class:"mb-4"},{default:n(()=>[t(u,{span:8},{default:n(()=>[s("div",Me,[e[13]||(e[13]=s("div",{class:"data-card-title"},"应收总额",-1)),s("div",$e,"¥"+_(g(m.totalReceivable)),1),e[14]||(e[14]=s("div",{class:"data-card-trend"},[s("span",{class:"trend-stable"},"来自全部数据")],-1))])]),_:1}),t(u,{span:8},{default:n(()=>[s("div",je,[e[16]||(e[16]=s("div",{class:"data-card-title"},"已收金额",-1)),s("div",Ke,"¥"+_(g(m.totalReceived)),1),s("div",Ge,[s("span",Ye,"↑ "+_(m.receivedPercent)+"%",1),e[15]||(e[15]=R(" 收款率 ",-1))])])]),_:1}),t(u,{span:8},{default:n(()=>[s("div",He,[e[18]||(e[18]=s("div",{class:"data-card-title"},"未收金额",-1)),s("div",Je,"¥"+_(g(m.totalUnpaid)),1),s("div",Qe,[e[17]||(e[17]=s("span",{class:"trend-danger"},"●",-1)),R(" 占比 "+_(m.unpaidPercent)+"% ",1)])])]),_:1})]),_:1}),t(G,{class:"search-card mb-4 search-bar"},{default:n(()=>[t(M,{inline:!0,model:o,class:"search-form"},{default:n(()=>[t(d,{label:"客户"},{default:n(()=>[t(y,{modelValue:o.customer,"onUpdate:modelValue":e[0]||(e[0]=l=>o.customer=l),placeholder:"请输入客户名称",size:"small"},null,8,["modelValue"])]),_:1}),t(d,{label:"日期"},{default:n(()=>[t(E,{modelValue:o.dateRange,"onUpdate:modelValue":e[1]||(e[1]=l=>o.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small",onChange:q},null,8,["modelValue"])]),_:1}),t(d,null,{default:n(()=>[t(r,{type:"primary",onClick:q,size:"small"},{default:n(()=>[t(i,null,{default:n(()=>[t(Y(ke))]),_:1}),e[19]||(e[19]=R(" 搜索 ",-1))]),_:1}),t(r,{onClick:le,size:"small"},{default:n(()=>[...e[20]||(e[20]=[R("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(G,null,{default:n(()=>[Ie((F(),j(Fe,{ref_key:"exportTableRef",ref:N,dataSource:K.value,selectionType:"all",onSelectionChange:l=>Ve(I)?I.value=l:I=l,rowKey:"id",storageKey:"receivable-export-selection",queryParams:o,fetchAllIds:ve,fetchItemsByIds:ge},{columns:n(()=>[t(b,{prop:"outboundDate",label:"出货日期",width:"120"},{default:n(({row:l})=>{var V;return[R(_((V=l.outboundDate)==null?void 0:V.substring(0,10)),1)]}),_:1}),t(b,{prop:"outboundNo",label:"货单号",width:"150"}),t(b,{prop:"deliveryNo",label:"编号",width:"150"}),t(b,{prop:"customer",label:"客户",width:"120"}),t(b,{prop:"productSpec",label:"品名规格","min-width":"150"}),t(b,{prop:"quantity",label:"匹数",width:"80"}),t(b,{prop:"weightKg",label:"重量(kg)",width:"100"}),t(b,{prop:"unitPrice",label:"单价(元)",width:"100"}),t(b,{prop:"receivableAmount",label:"应收金额(元)",width:"120"},{default:n(({row:l})=>[R(" ¥"+_(g(l.receivableAmount)),1)]),_:1}),t(b,{prop:"receivedAmount",label:"已收金额(元)",width:"120"},{default:n(({row:l})=>[R(" ¥"+_(g(l.receivedAmount)),1)]),_:1}),t(b,{prop:"taxInvoiceAmount",label:"税票金额(元)",width:"120"},{default:n(({row:l})=>[R(" ¥"+_(g(l.taxInvoiceAmount||0)),1)]),_:1}),t(b,{prop:"unpaidAmount",label:"未收金额(元)",width:"120"},{default:n(({row:l})=>[s("span",{class:ze({"text-danger":l.unpaidAmount>0})}," ¥"+_(g(l.unpaidAmount)),3)]),_:1}),t(b,{prop:"remark",label:"备注","min-width":"120","show-overflow-tooltip":""}),t(b,{label:"操作",width:"200",fixed:"right"},{default:n(({row:l})=>[t(Te,{items:me(l)},null,8,["items"])]),_:1})]),_:1},8,["dataSource","onSelectionChange","queryParams"])),[[_e,O.value]]),s("div",We,[t(fe,{"current-page":w.currentPage,"onUpdate:currentPage":e[2]||(e[2]=l=>w.currentPage=l),"page-size":w.pageSize,"onUpdate:pageSize":e[3]||(e[3]=l=>w.pageSize=l),"page-sizes":[10,20,50,100],total:w.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ne,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1}),s("div",Xe,[e[24]||(e[24]=s("div",{class:"summary-bar__meta"},[s("span",{class:"summary-bar__meta-dot"}),s("span",{class:"summary-bar__meta-text"},"汇总（来自搜索数据）")],-1)),s("div",Ze,[s("div",Pe,[e[21]||(e[21]=s("span",{class:"summary-bar__label"},"应收总额",-1)),s("span",qe,"¥"+_(g(v.totalReceivable)),1)]),s("div",et,[e[22]||(e[22]=s("span",{class:"summary-bar__label"},"已收金额",-1)),s("span",tt,"¥"+_(g(v.totalReceived)),1)]),s("div",at,[e[23]||(e[23]=s("span",{class:"summary-bar__label"},"未收金额",-1)),s("span",lt,"¥"+_(g(v.totalUnpaid)),1)])])]),t(be,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=l=>B.value=l),title:"收款登记",width:"1000px"},{footer:n(()=>[s("span",nt,[t(r,{onClick:e[9]||(e[9]=l=>B.value=!1)},{default:n(()=>[...e[27]||(e[27]=[R("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:de},{default:n(()=>[...e[28]||(e[28]=[R("确定",-1)])]),_:1})])]),default:n(()=>[t(M,{model:c,rules:ae,ref_key:"receiveFormRef",ref:P,"label-width":"100px"},{default:n(()=>[t(k,{gutter:24},{default:n(()=>[t(u,{span:12},{default:n(()=>[t(ee,{"content-position":"left"},{default:n(()=>[...e[25]||(e[25]=[R("基础信息",-1)])]),_:1}),t(d,{label:"客户名称"},{default:n(()=>{var l;return[t(y,{value:(l=x.value)==null?void 0:l.customer,readonly:""},null,8,["value"])]}),_:1}),t(d,{label:"应收金额"},{default:n(()=>{var l;return[t(y,{value:`¥${g(((l=x.value)==null?void 0:l.receivableAmount)||0)}`,readonly:""},null,8,["value"])]}),_:1}),t(d,{label:"已收金额"},{default:n(()=>{var l;return[t(y,{value:`¥${g(((l=x.value)==null?void 0:l.receivedAmount)||0)}`,readonly:""},null,8,["value"])]}),_:1}),t(d,{label:"未收金额"},{default:n(()=>{var l;return[t(y,{value:`¥${g(((l=x.value)==null?void 0:l.unpaidAmount)||0)}`,readonly:"",style:{color:"#ff4d4f"}},null,8,["value"])]}),_:1}),t(d,{label:"本次收款",prop:"amount"},{default:n(()=>{var l;return[t(te,{modelValue:c.amount,"onUpdate:modelValue":e[4]||(e[4]=V=>c.amount=V),min:0,max:((l=x.value)==null?void 0:l.unpaidAmount)||0,precision:2,style:{width:"100%"}},null,8,["modelValue","max"])]}),_:1}),t(d,{label:"备注",prop:"remark"},{default:n(()=>[t(y,{modelValue:c.remark,"onUpdate:modelValue":e[5]||(e[5]=l=>c.remark=l),type:"textarea",rows:3,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1}),t(u,{span:12},{default:n(()=>[t(ee,{"content-position":"left"},{default:n(()=>[...e[26]||(e[26]=[R("税务与附件",-1)])]),_:1}),t(d,{label:"税票金额",prop:"taxInvoiceAmount"},{default:n(()=>[t(te,{modelValue:c.taxInvoiceAmount,"onUpdate:modelValue":e[6]||(e[6]=l=>c.taxInvoiceAmount=l),min:0,precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(d,{label:"税票附件"},{default:n(()=>{var l;return[t(Oe,{modelValue:c.taxAttachments,"onUpdate:modelValue":e[7]||(e[7]=V=>c.taxAttachments=V),"record-type":"receivable","record-id":(l=x.value)==null?void 0:l.id},null,8,["modelValue","record-id"])]}),_:1}),t(d,{label:"其他附件"},{default:n(()=>{var l;return[t(Ee,{modelValue:c.otherAttachments,"onUpdate:modelValue":e[8]||(e[8]=V=>c.otherAttachments=V),"record-type":"receivable","record-id":(l=x.value)==null?void 0:l.id},null,8,["modelValue","record-id"])]}),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});const mt=Ue(ot,[["__scopeId","data-v-da0d4217"]]);export{mt as default};
