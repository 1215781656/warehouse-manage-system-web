var S=(M,V,_)=>new Promise((q,v)=>{var h=m=>{try{t(_.next(m))}catch(N){v(N)}},w=m=>{try{t(_.throw(m))}catch(N){v(N)}},t=m=>m.done?q(m.value):Promise.resolve(m.value).then(h,w);t((_=_.apply(M,V)).next())});import{d as re,r as U,a as $,k as j,F as ne,l as ue,c as O,g as W,b as o,w as l,T as ie,G as de,e as se,x as E,E as R,f as s,z as me,o as k,h as f,B as ce,q as J,H as L,I as Q,i as pe,_ as ge}from"./index-0d744b35.js";import{f as B}from"./date-70ed563a.js";import{O as be}from"./OperationBar-ba9dfaef.js";import{T as fe}from"./TaxInvoiceUpload-5376d54e.js";import{R as _e}from"./index-468e0e38.js";import{u as Ve}from"./options-9fb748fa.js";const ve={class:"outbound-edit"},we={class:"page-header"},ye={class:"form-actions"},Ne=re({__name:"Edit",setup(M){const V=de(),_=se(),q=Ve(),v=U(!1),h=U(),w=U(!1),t=$({outboundDate:B(new Date),outboundNo:"",deliveryNo:"",customer:"",quantity:null,weightKg:null,unitPrice:null,amount:null,consignee:"",taxAttachments:[],colorFabricId:"",composition:"",color:"",process:"",gramWeight:null,customerNote:"",remark:""}),m=U([]),N=()=>S(this,null,function*(){const d=yield E.getStockList({});m.value=(d||[]).map(e=>{var n,c,u,i,a;return{id:(n=e.colorFabric)==null?void 0:n.id,productSpec:(c=e.colorFabric)==null?void 0:c.productSpec,composition:(u=e.colorFabric)==null?void 0:u.composition,color:(i=e.colorFabric)==null?void 0:i.color,weight:(a=e.colorFabric)==null?void 0:a.weight,currentStock:e.currentQuantity}})}),z=()=>{const d=m.value.find(e=>e.id===t.colorFabricId);d&&(t.composition=d.composition||"",t.color=d.color||"",t.gramWeight=Number(d.weight||0))},g=$({color:"",rows:[]}),I=d=>{g.rows.splice(d+1,0,{uid:Math.random().toString(36).slice(2),cells:Array(10).fill("")})},G=d=>{g.rows.splice(d,1),g.rows.length||I(-1)},C=(d,e,n)=>{if(e===null||e===""||e===void 0)return n(new Error("请输入有效数字"));const c=Number(e);if(Number.isNaN(c))return n(new Error("请输入有效数字"));n()},H={outboundDate:[{required:!0,message:"请选择出货日期",trigger:"change"}],outboundNo:[{required:!0,message:"请输入货单号",trigger:"blur"}],customer:[{required:!0,message:"请输入客户名称",trigger:"blur"}],quantity:[{required:!0,validator:C,trigger:"blur"}],weightKg:[{required:!0,validator:C,trigger:"blur"}],unitPrice:[{required:!0,validator:C,trigger:"blur"}],consignee:[{required:!0,message:"请输入签收人",trigger:"blur"}]},K=j(()=>(Number(t.weightKg||0)*Number(t.unitPrice||0)).toFixed(2)),A=j(()=>`draft:outbound:edit:${V.params.id}`),X=()=>S(this,null,function*(){var d,e,n,c,u;try{v.value=!0;const i=V.params.id;if(!i)throw new Error("ID无效");const a=yield E.getOutboundDetail(i);Object.assign(t,{outboundDate:a.outboundDate?B(a.outboundDate):B(new Date),outboundNo:a.outboundNo,deliveryNo:a.deliveryNo,customer:a.customer,quantity:a.quantity,weightKg:Number(a.weightKg),unitPrice:Number(a.unitPrice),amount:Number(a.amount),consignee:a.consignee,taxAttachments:a.taxAttachments||[],colorFabricId:((d=a.colorFabric)==null?void 0:d.id)||"",composition:a.composition||((e=a.colorFabric)==null?void 0:e.composition)||"",color:a.color||((n=a.colorFabric)==null?void 0:n.color)||"",process:a.process||"",gramWeight:a.gramWeight||((c=a.colorFabric)==null?void 0:c.weight)||null,customerNote:a.customerNote||"",remark:a.remark||""});const p=(u=a==null?void 0:a.outboundDetails)!=null?u:[],x=Array.isArray(p)?p.map(b=>Number(b)):[];g.rows=[];for(let b=0;b<x.length;b+=10)g.rows.push({uid:Math.random().toString(36).slice(2),cells:x.slice(b,b+10).map(y=>String(y))});const D=localStorage.getItem(A.value);D&&Object.assign(t,JSON.parse(D))}catch(i){R.error("加载详情失败")}finally{v.value=!1}}),T=()=>{_.back()},P=()=>{t.amount=parseFloat((t.weightKg*t.unitPrice).toFixed(2))},Z=()=>S(this,null,function*(){if(!(yield h.value.validate()))return;const e=V.params.id;try{w.value=!0;const n=(g.rows||[]).flatMap(a=>a.cells||[]).filter(a=>a!==""&&a!==null&&!Number.isNaN(Number(a))).map(a=>Number(a)),c=n.reduce((a,p)=>a+Number(p||0),0),u=n.length?Number(c.toFixed(2)):Number(t.weightKg||0),i=n.length?n.length:Number(t.quantity||0);yield E.updateOutbound(e,{outboundDate:t.outboundDate,outboundNo:t.outboundNo,deliveryNo:t.deliveryNo,customer:t.customer,quantity:i,weightKg:u,unitPrice:Number(t.unitPrice||0),amount:K.value,consignee:t.consignee,outboundDetails:n,colorFabricId:t.colorFabricId,composition:t.composition,color:t.color,process:t.process,gramWeight:t.gramWeight,customerNote:t.customerNote,remark:t.remark}),localStorage.removeItem(A.value),R.success("保存成功"),q.invalidate(),_.push("/inventory/out")}catch(n){R.error((n==null?void 0:n.message)||"保存失败")}finally{w.value=!1}});return ne(t,()=>{localStorage.setItem(A.value,JSON.stringify(t))},{deep:!0}),ue(()=>{N(),X(),g.rows.length||I(-1)}),(d,e)=>{const n=s("el-button"),c=s("el-date-picker"),u=s("el-form-item"),i=s("el-col"),a=s("el-input"),p=s("el-row"),x=s("el-divider"),D=s("el-option"),b=s("el-select"),y=s("el-input-number"),Y=s("el-table-column"),ee=s("el-table"),oe=s("el-form"),te=s("el-card"),le=me("loading");return k(),O("div",ve,[W("div",we,[o(n,{class:"back-btn",onClick:T},{default:l(()=>[...e[17]||(e[17]=[f("返回",-1)])]),_:1}),e[18]||(e[18]=W("h1",{class:"page-title"},"编辑出库",-1))]),o(ie,{name:"fade"},{default:l(()=>[ce((k(),J(te,null,{default:l(()=>[o(oe,{model:t,rules:H,ref_key:"formRef",ref:h,"label-width":"100px"},{default:l(()=>[o(p,{gutter:16},{default:l(()=>[o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"出货日期",prop:"outboundDate"},{default:l(()=>[o(c,{modelValue:t.outboundDate,"onUpdate:modelValue":e[0]||(e[0]=r=>t.outboundDate=r),type:"date","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"货单号",prop:"outboundNo"},{default:l(()=>[o(a,{modelValue:t.outboundNo,"onUpdate:modelValue":e[1]||(e[1]=r=>t.outboundNo=r),placeholder:"请输入货单号"},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"编号",prop:"deliveryNo"},{default:l(()=>[o(a,{modelValue:t.deliveryNo,"onUpdate:modelValue":e[2]||(e[2]=r=>t.deliveryNo=r)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(p,{gutter:16},{default:l(()=>[o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"客户",prop:"customer"},{default:l(()=>[o(_e,{modelValue:t.customer,"onUpdate:modelValue":e[3]||(e[3]=r=>t.customer=r),type:"customer","allow-create":!0,placeholder:"请输入客户名称"},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"签收人",prop:"consignee"},{default:l(()=>[o(a,{modelValue:t.consignee,"onUpdate:modelValue":e[4]||(e[4]=r=>t.consignee=r),placeholder:"请输入签收人"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(x,null,{default:l(()=>[...e[19]||(e[19]=[f("色布信息",-1)])]),_:1}),o(p,{gutter:16},{default:l(()=>[o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"品名规格",prop:"colorFabricId"},{default:l(()=>[o(b,{modelValue:t.colorFabricId,"onUpdate:modelValue":e[5]||(e[5]=r=>t.colorFabricId=r),filterable:"",placeholder:"请选择品名规格",onChange:z,style:{width:"100%"}},{default:l(()=>[(k(!0),O(L,null,Q(m.value,r=>(k(),J(D,{key:r.id,label:`${r.productSpec} (${r.currentStock}匹)`,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"成分",prop:"composition"},{default:l(()=>[o(a,{modelValue:t.composition,"onUpdate:modelValue":e[6]||(e[6]=r=>t.composition=r)},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"颜色",prop:"color"},{default:l(()=>[o(a,{modelValue:t.color,"onUpdate:modelValue":e[7]||(e[7]=r=>t.color=r)},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"工艺",prop:"process"},{default:l(()=>[o(a,{modelValue:t.process,"onUpdate:modelValue":e[8]||(e[8]=r=>t.process=r)},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"克重",prop:"gramWeight"},{default:l(()=>[o(y,{modelValue:t.gramWeight,"onUpdate:modelValue":e[9]||(e[9]=r=>t.gramWeight=r),style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"客户备注",prop:"customerNote"},{default:l(()=>[o(a,{modelValue:t.customerNote,"onUpdate:modelValue":e[10]||(e[10]=r=>t.customerNote=r),type:"textarea",rows:1},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:24},{default:l(()=>[o(u,{label:"备注",prop:"remark"},{default:l(()=>[o(a,{modelValue:t.remark,"onUpdate:modelValue":e[11]||(e[11]=r=>t.remark=r),type:"textarea",rows:2},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(p,{gutter:16},{default:l(()=>[o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"匹数",prop:"quantity"},{default:l(()=>[o(y,{modelValue:t.quantity,"onUpdate:modelValue":e[12]||(e[12]=r=>t.quantity=r),min:1,style:{width:"100%"},onChange:P},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"重量(kg)",prop:"weightKg"},{default:l(()=>[o(y,{modelValue:t.weightKg,"onUpdate:modelValue":e[13]||(e[13]=r=>t.weightKg=r),min:.1,precision:2,style:{width:"100%"},onChange:P},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:l(()=>[o(u,{label:"单价(元)",prop:"unitPrice"},{default:l(()=>[o(y,{modelValue:t.unitPrice,"onUpdate:modelValue":e[14]||(e[14]=r=>t.unitPrice=r),min:.01,precision:2,style:{width:"100%"},onChange:P},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(u,{label:"金额(元)",prop:"amount"},{default:l(()=>[o(a,{modelValue:K.value,"onUpdate:modelValue":e[15]||(e[15]=r=>K.value=r),readonly:""},{prefix:l(()=>[...e[20]||(e[20]=[f("¥",-1)])]),_:1},8,["modelValue"])]),_:1}),o(u,{label:"附件"},{default:l(()=>[o(fe,{"model-value":t.taxAttachments,"record-type":"outbound","record-id":pe(V).params.id,"onUpdate:modelValue":e[16]||(e[16]=r=>t.taxAttachments=r)},null,8,["model-value","record-id"])]),_:1}),o(x,null,{default:l(()=>[...e[21]||(e[21]=[f("出库明细",-1)])]),_:1}),o(ee,{data:g.rows,border:"","highlight-current-row":"",height:"360",style:{width:"100%"}},{default:l(()=>[(k(),O(L,null,Q(10,r=>o(Y,{key:r,label:String(r),"min-width":80,align:"center"},{default:l(({row:F})=>[o(a,{modelValue:F.cells[r-1],"onUpdate:modelValue":ae=>F.cells[r-1]=ae,inputmode:"numeric"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label"])),64)),o(Y,{label:"操作",fixed:"right","min-width":120,align:"center"},{default:l(({$index:r})=>[o(n,{class:"circle-btn",onClick:F=>I(r)},{default:l(()=>[...e[22]||(e[22]=[f("+",-1)])]),_:1},8,["onClick"]),o(n,{class:"circle-btn danger",onClick:F=>G(r)},{default:l(()=>[...e[23]||(e[23]=[f("-",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),W("div",ye,[o(be,{loading:w.value},{button:l(()=>[o(n,{onClick:T},{default:l(()=>[...e[24]||(e[24]=[f("返回",-1)])]),_:1}),o(n,{type:"primary",loading:w.value,onClick:Z},{default:l(()=>[...e[25]||(e[25]=[f("保存",-1)])]),_:1},8,["loading"])]),_:1},8,["loading"])])]),_:1},8,["model"])]),_:1})),[[le,v.value]])]),_:1})])}}});const qe=ge(Ne,[["__scopeId","data-v-b4443861"]]);export{qe as default};
