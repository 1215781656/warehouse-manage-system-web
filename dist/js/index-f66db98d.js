var I=(B,C,_)=>new Promise((y,n)=>{var f=m=>{try{h(_.next(m))}catch(v){n(v)}},R=m=>{try{h(_.throw(m))}catch(v){n(v)}},h=m=>m.done?y(m.value):Promise.resolve(m.value).then(f,R);h((_=_.apply(B,C)).next())});import{r as D,d as se,u as ue,a as J,k as pe,l as be,c as ge,g as Y,i as w,q as K,w as s,v as O,b as l,e as me,x as U,E,y as fe,f as N,z as he,o as k,p as ve,h as A,A as _e,t as G,s as we,B as Ne,C as Se,D as ye,_ as Re}from"./index-0d744b35.js";import{r as H,f as Fe}from"./date-70ed563a.js";import{R as Ie}from"./ResponsiveActions-ad4bb68b.js";import{E as Ce}from"./ExportSelectionTable-ba17256c.js";import{R as Z}from"./index-468e0e38.js";import{u as De}from"./options-9fb748fa.js";function Ee(B,C,_=400){const y=D(null);let n="",f=null;return{trigger:()=>{y.value&&(clearTimeout(y.value),y.value=null),y.value=window.setTimeout(()=>I(this,null,function*(){const h=B(),m=JSON.stringify(h||{});if(m!==n){n=m,f&&f.abort(),f=new AbortController;try{yield C(f.signal)}catch(v){}}}),_)}}}const ke={class:"inbound"},Ae={class:"page-header"},Ve={class:"header-actions"},ze={class:"pagination-container"},Ke=se({__name:"index",setup(B){const C=me(),_=ue(),y=De(),n=J({dateRange:"",inboundNo:"",supplier:"",productSpec:""}),f=D([]),R=D(!1);let h=[];const m=D(),v=D(!1),V=D(0),L=D(!1),S=J({currentPage:1,pageSize:10,total:0}),Q=J({id:"",inboundDate:new Date,inboundNo:"",supplier:"",productSpec:"",composition:"",weight:0,width:0,color:"",colorNo:"",batchNo:"",quantity:0,weightKg:0,unitPrice:0,amount:0});pe(()=>(Q.weightKg*Q.unitPrice).toFixed(2));const $=o=>o.toLocaleString("zh-CN",{minimumFractionDigits:2}),P=()=>{F()},q=()=>{n.dateRange="",n.inboundNo="",n.supplier="",n.productSpec="",F()},F=()=>I(this,null,function*(){if(F.signal instanceof AbortSignal)return yield W(F.signal);R.value=!0;try{const o={};if(n.inboundNo&&(o.inboundNo=n.inboundNo),n.supplier&&(o.supplier=n.supplier),n.productSpec&&(o.productSpec=n.productSpec),n.dateRange){const{start:a,end:e}=H(n.dateRange);a&&(o.dateStart=a),e&&(o.dateEnd=e)}const t=yield U.getInboundList(o);f.value=(t||[]).map(a=>{var e,u,g,c,b,p,d;return{id:a.id,inboundDate:a.inboundDate,inboundNo:a.inboundNo,supplier:a.supplier,productSpec:(e=a.colorFabric)==null?void 0:e.productSpec,composition:(u=a.colorFabric)==null?void 0:u.composition,weight:(g=a.colorFabric)==null?void 0:g.weight,width:(c=a.colorFabric)==null?void 0:c.width,color:(b=a.colorFabric)==null?void 0:b.color,colorNo:(p=a.colorFabric)==null?void 0:p.colorNo,batchNo:(d=a.colorFabric)==null?void 0:d.batchNo,quantity:a.quantity,weightKg:Number(a.weightKg),unitPrice:Number(a.unitPrice),amount:Number(a.amount)}}),S.total=f.value.length}catch(o){E.error("加载数据失败")}finally{R.value=!1}}),W=o=>I(this,null,function*(){R.value=!0;try{const t={};if(n.inboundNo&&(t.inboundNo=n.inboundNo),n.supplier&&(t.supplier=n.supplier),n.productSpec&&(t.productSpec=n.productSpec),n.dateRange){const{start:e,end:u}=H(n.dateRange);e&&(t.dateStart=e),u&&(t.dateEnd=u)}const a=yield U.getInboundList(t,{signal:o});f.value=(a||[]).map(e=>{var u,g,c,b,p,d,i;return{id:e.id,inboundDate:e.inboundDate,inboundNo:e.inboundNo,supplier:e.supplier,productSpec:(u=e.colorFabric)==null?void 0:u.productSpec,composition:(g=e.colorFabric)==null?void 0:g.composition,weight:(c=e.colorFabric)==null?void 0:c.weight,width:(b=e.colorFabric)==null?void 0:b.width,color:(p=e.colorFabric)==null?void 0:p.color,colorNo:(d=e.colorFabric)==null?void 0:d.colorNo,batchNo:(i=e.colorFabric)==null?void 0:i.batchNo,quantity:e.quantity,weightKg:Number(e.weightKg),unitPrice:Number(e.unitPrice),amount:Number(e.amount)}}),S.total=f.value.length}catch(t){(t==null?void 0:t.name)==="CanceledError"||(t==null?void 0:t.code)==="ERR_CANCELED"||E.error("加载数据失败")}finally{R.value=!1}}),{trigger:M}=Ee(()=>({dateRange:n.dateRange,inboundNo:n.inboundNo,supplier:n.supplier,productSpec:n.productSpec}),o=>W(o)),x=o=>{S.pageSize=o,F()},ee=o=>{S.currentPage=o,F()},oe=o=>{C.push({name:"InventoryInEdit",params:{id:o.id}})},te=o=>{C.push({name:"InventoryInDetail",params:{id:o.id}})},ne=o=>{ye.confirm("确定要删除这条入库记录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>I(this,null,function*(){yield U.deleteInbound(o.id,{operator:"admin"}),E.success("删除成功"),y.invalidate(),F()}))},ae=o=>{const t=[{label:"详情",onClick:()=>te(o)}];return _.can(a=>a.Inventory.In.Edit)&&t.push({label:"编辑",onClick:()=>oe(o)}),_.can(a=>a.Inventory.In.Delete)&&t.push({label:"删除",onClick:()=>ne(o),danger:!0}),t},le=()=>{C.push({name:"InventoryInAdd"})},ie=()=>I(this,null,function*(){var o,t,a;if(!h||h.length===0){E.warning("请勾选数据");return}L.value=!1,v.value=!0,V.value=5;try{const e=(t=(o=m.value)==null?void 0:o.isAllSelected)!=null&&t.call(o)?"Y":"N",u={ids:e==="Y"?null:h,isAll:e,inboundNo:n.inboundNo||void 0,supplier:n.supplier||void 0,productSpec:n.productSpec||void 0,dateStart:n.dateRange&&n.dateRange[0]?n.dateRange[0]:void 0,dateEnd:n.dateRange&&n.dateRange[1]?n.dateRange[1]:void 0},g=yield fe.exportReport("inbound",u,d=>{if(d&&typeof d.loaded=="number"){const i=d.total||0;if(i>0){const j=Math.min(90,Math.max(10,Math.floor(d.loaded/i*90)));V.value=j}}}),c=new Blob([g],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),b=URL.createObjectURL(c),p=document.createElement("a");p.href=b,p.download="入库导出.xlsx",p.click(),URL.revokeObjectURL(b),V.value=100,(a=m.value)==null||a.clearSelection(),E.success("导出成功")}catch(e){L.value=!0,E.error("导出失败")}finally{v.value=!1,setTimeout(()=>{V.value=0,L.value=!1},400)}}),z=new Map;let T=null;const X=o=>{const t={};if(o!=null&&o.inboundNo&&(t.inboundNo=o.inboundNo),o!=null&&o.supplier&&(t.supplier=o.supplier),o!=null&&o.productSpec&&(t.productSpec=o.productSpec),o!=null&&o.dateRange){const{start:a,end:e}=H(o.dateRange);a&&(t.dateStart=a),e&&(t.dateEnd=e)}return t},re=o=>I(this,null,function*(){const a=((yield U.getInboundList(X(o)))||[]).map(e=>{var u,g,c,b,p,d,i;return{id:e.id,inboundDate:e.inboundDate,inboundNo:e.inboundNo,supplier:e.supplier,productSpec:(u=e.colorFabric)==null?void 0:u.productSpec,composition:(g=e.colorFabric)==null?void 0:g.composition,weight:(c=e.colorFabric)==null?void 0:c.weight,width:(b=e.colorFabric)==null?void 0:b.width,color:(p=e.colorFabric)==null?void 0:p.color,colorNo:(d=e.colorFabric)==null?void 0:d.colorNo,batchNo:(i=e.colorFabric)==null?void 0:i.batchNo,quantity:e.quantity,weightKg:Number(e.weightKg),unitPrice:Number(e.unitPrice),amount:Number(e.amount)}});T=a,z.clear();for(const e of a)z.set(e.id,e);return a.map(e=>e.id)}),ce=o=>I(this,null,function*(){if(!T){T=((yield U.getInboundList(X(n)))||[]).map(e=>{var u,g,c,b,p,d,i;return{id:e.id,inboundDate:e.inboundDate,inboundNo:e.inboundNo,supplier:e.supplier,productSpec:(u=e.colorFabric)==null?void 0:u.productSpec,composition:(g=e.colorFabric)==null?void 0:g.composition,weight:(c=e.colorFabric)==null?void 0:c.weight,width:(b=e.colorFabric)==null?void 0:b.width,color:(p=e.colorFabric)==null?void 0:p.color,colorNo:(d=e.colorFabric)==null?void 0:d.colorNo,batchNo:(i=e.colorFabric)==null?void 0:i.batchNo,quantity:e.quantity,weightKg:Number(e.weightKg),unitPrice:Number(e.unitPrice),amount:Number(e.amount)}}),z.clear();for(const e of T)z.set(e.id,e)}const t=[];for(const a of o){const e=z.get(a);e&&t.push(e)}return t});return be(()=>{F()}),(o,t)=>{const a=N("el-icon"),e=N("el-button"),u=N("el-progress"),g=N("el-date-picker"),c=N("el-form-item"),b=N("el-input"),p=N("el-form"),d=N("el-card"),i=N("el-table-column"),j=N("el-pagination"),de=he("loading");return k(),ge("div",ke,[Y("div",Ae,[t[7]||(t[7]=Y("h1",{class:"page-title"},"入库管理",-1)),Y("div",Ve,[w(_).can(r=>r.Inventory.In.Add)?(k(),K(e,{key:0,type:"primary",onClick:le},{default:s(()=>[l(a,null,{default:s(()=>[l(w(ve))]),_:1}),t[6]||(t[6]=A(" 新增入库 ",-1))]),_:1})):O("",!0),v.value?(k(),K(u,{key:1,percentage:V.value,status:L.value?"exception":void 0,style:{width:"160px"}},null,8,["percentage","status"])):O("",!0),w(_).can(r=>r.Inventory.In.Export)?(k(),K(e,{key:2,onClick:ie,loading:v.value,disabled:v.value,type:"primary"},{default:s(()=>[v.value?O("",!0):(k(),K(a,{key:0},{default:s(()=>[l(w(_e))]),_:1})),A(" "+G(v.value?"导出中...":"导出"),1)]),_:1},8,["loading","disabled"])):O("",!0)])]),l(d,{class:"search-card mb-4 search-bar"},{default:s(()=>[l(p,{inline:!0,model:n,class:"search-form"},{default:s(()=>[l(c,{label:"入库日期"},{default:s(()=>[l(g,{modelValue:n.dateRange,"onUpdate:modelValue":t[0]||(t[0]=r=>n.dateRange=r),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small","value-format":"YYYY-MM-DD",onChange:w(M)},null,8,["modelValue","onChange"])]),_:1}),l(c,{label:"货单编号"},{default:s(()=>[l(b,{modelValue:n.inboundNo,"onUpdate:modelValue":t[1]||(t[1]=r=>n.inboundNo=r),placeholder:"请输入货单编号",size:"small",onChange:w(M)},null,8,["modelValue","onChange"])]),_:1}),l(c,{label:"供应商"},{default:s(()=>[l(Z,{modelValue:n.supplier,"onUpdate:modelValue":[t[2]||(t[2]=r=>n.supplier=r),w(M)],type:"supplier",placeholder:"请选择供应商"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(c,{label:"品名规格"},{default:s(()=>[l(Z,{modelValue:n.productSpec,"onUpdate:modelValue":[t[3]||(t[3]=r=>n.productSpec=r),w(M)],type:"productSpec",placeholder:"请选择品名规格"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),l(c,null,{default:s(()=>[l(e,{type:"primary",onClick:P,size:"small"},{default:s(()=>[l(a,null,{default:s(()=>[l(w(we))]),_:1}),t[8]||(t[8]=A(" 搜索 ",-1))]),_:1}),l(e,{onClick:q,size:"small"},{default:s(()=>[...t[9]||(t[9]=[A("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),l(d,null,{default:s(()=>[Ne((k(),K(Ce,{ref_key:"exportTableRef",ref:m,dataSource:f.value,selectionType:"all",onSelectionChange:r=>Se(h)?h.value=r:h=r,rowKey:"id",storageKey:"inbound-export-selection",queryParams:n,fetchAllIds:re,fetchItemsByIds:ce},{columns:s(()=>[l(i,{label:"入库日期",width:"120"},{default:s(({row:r})=>[A(G(w(Fe)(r.inboundDate)),1)]),_:1}),l(i,{prop:"inboundNo",label:"货单编号",width:"150"}),l(i,{prop:"supplier",label:"供应商",width:"120"}),l(i,{prop:"productSpec",label:"品名规格","min-width":"150"}),l(i,{prop:"composition",label:"成分",width:"120"}),l(i,{prop:"weight",label:"克重(g/m²)",width:"100"}),l(i,{prop:"width",label:"全幅宽(cm)",width:"100"}),l(i,{prop:"color",label:"颜色",width:"80"}),l(i,{prop:"colorNo",label:"色号",width:"100"}),l(i,{prop:"batchNo",label:"缸号",width:"100"}),l(i,{prop:"quantity",label:"匹数",width:"80"}),l(i,{prop:"weightKg",label:"重量(kg)",width:"100"}),l(i,{prop:"unitPrice",label:"单价(元)",width:"100"}),l(i,{prop:"amount",label:"金额(元)",width:"120"},{default:s(({row:r})=>[A(" ¥"+G($(r.amount)),1)]),_:1}),l(i,{label:"操作",width:"180",fixed:"right"},{default:s(({row:r})=>[l(Ie,{items:ae(r)},null,8,["items"])]),_:1})]),_:1},8,["dataSource","onSelectionChange","queryParams"])),[[de,R.value]]),Y("div",ze,[l(j,{"current-page":S.currentPage,"onUpdate:currentPage":t[4]||(t[4]=r=>S.currentPage=r),"page-size":S.pageSize,"onUpdate:pageSize":t[5]||(t[5]=r=>S.pageSize=r),"page-sizes":[10,20,50,100],total:S.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:x,onCurrentChange:ee},null,8,["current-page","page-size","total"])])]),_:1})])}}});const je=Re(Ke,[["__scopeId","data-v-99a67a4f"]]);export{je as default};
