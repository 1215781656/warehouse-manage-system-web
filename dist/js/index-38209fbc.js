var C=(S,f,r)=>new Promise((v,o)=>{var u=d=>{try{c(r.next(d))}catch(k){o(k)}},g=d=>{try{c(r.throw(d))}catch(k){o(k)}},c=d=>d.done?v(d.value):Promise.resolve(d.value).then(u,g);c((r=r.apply(S,f)).next())});import{d as J,r as m,k as U,l as O,c as _,g as h,b,B as D,H as $,I as q,h as x,w as I,R as w,E as V,D as A,f as N,z as F,o as p,n as j,t as K,q as G,v as Q,P as W,_ as X}from"./index-0d744b35.js";const Y={class:"permission-manage"},Z={class:"left-panel"},ee={class:"user-list"},se=["onClick"],te={class:"right-panel"},ae={class:"panel-header"},ne={key:0,class:"permission-tree"},le={class:"custom-tree-node"},oe={key:1,class:"empty-tip"},ie=J({__name:"index",setup(S){const f=m([]),r=m([]),v=m(""),o=m(""),u=m(null),g=m(!1),c=m(!1),d={admin:"管理员",employee:"员工"},k=e=>d[e]||e,E=U(()=>v.value?f.value.filter(e=>e.username.includes(v.value)):f.value),R=U(()=>{const e=JSON.parse(JSON.stringify(r.value)),s={},l=[],i=t=>t.code==="system:menu"||t.code==="system:view";return e.forEach(t=>{s[t.id]=t,t.children=[],i(t)&&(t.disabled=!0)}),e.forEach(t=>{t.parentId&&s[t.parentId]?s[t.parentId].children.push(t):l.push(t)}),l}),z=()=>C(this,null,function*(){g.value=!0;try{const[e,s]=yield Promise.all([w.getUserList(),w.getPermissionList()]);f.value=e,r.value=s}finally{g.value=!1}}),P=e=>C(this,null,function*(){if(c.value)return;o.value=e.id,c.value=!0;const s=l=>{if(o.value!==e.id)return;const i=e.role,t=r.value.filter(a=>a.code==="system:menu"||a.code==="system:view"),y=t.map(a=>a.id);let n=l.filter(a=>!y.includes(a.id));i==="admin"&&(n=[...n,...t]),W(()=>{T(n),c.value=!1})};if(e.permissions)s(e.permissions);else try{const l=yield w.getUserDetail(e.id);if(o.value!==e.id)return;e.permissions=l.permissions,s(l.permissions)}catch(l){c.value=!1}}),T=e=>{if(!u.value)return;if(!e||e.length===0){u.value.setCheckedKeys([],!1);return}const s=e.filter(l=>!r.value.some(i=>i.parentId===l.id)).map(l=>l.id);u.value.setCheckedKeys(s,!1)},M=()=>C(this,null,function*(){if(!o.value)return;const e=f.value.find(s=>s.id===o.value);if(!e){V.error("找不到当前用户");return}try{yield A.confirm(`确定要修改用户 "${e.username}" 的权限吗？此操作将立即生效。`,"权限修改确认",{confirmButtonText:"确定修改",cancelButtonText:"取消",type:"warning"});const s=u.value.getCheckedKeys(),l=u.value.getHalfCheckedKeys();let i=[...s,...l];const y=r.value.filter(n=>n.code==="system:menu"||n.code==="system:view").map(n=>n.id);if(e.role!=="admin")i=i.filter(n=>!y.includes(n));else{const n=y.filter(a=>!i.includes(a));n.length>0&&i.push(...n)}if(yield w.assignPermissions(o.value,i),V.success("权限保存成功"),e){const n=yield w.getUserDetail(o.value);e.permissions=n.permissions,o.value===e.id&&T(e.permissions)}}catch(s){s!=="cancel"&&console.error(s)}}),L=e=>({system:"danger",menu:"primary",button:"info"})[e]||"",H=e=>({system:"系统",menu:"菜单",button:"按钮"})[e]||e;return O(z),(e,s)=>{const l=N("el-input"),i=N("el-tag"),t=N("el-button"),y=N("el-tree"),n=F("loading");return p(),_("div",Y,[h("div",Z,[s[1]||(s[1]=h("div",{class:"panel-header"},"用户列表",-1)),b(l,{modelValue:v.value,"onUpdate:modelValue":s[0]||(s[0]=a=>v.value=a),placeholder:"搜索用户",clearable:"",class:"search-input"},null,8,["modelValue"]),D((p(),_("div",ee,[(p(!0),_($,null,q(E.value,a=>(p(),_("div",{key:a.id,class:j(["user-item",{active:o.value===a.id}]),onClick:B=>P(a)},[x(K(a.username)+" ",1),a.role?(p(),G(i,{key:0,size:"small"},{default:I(()=>[x(K(k(a.role)),1)]),_:2},1024)):Q("",!0)],10,se))),128))])),[[n,g.value]])]),h("div",te,[h("div",ae,[s[3]||(s[3]=x(" 权限配置 ",-1)),b(t,{type:"primary",size:"small",disabled:!o.value,onClick:M,style:{float:"right"}},{default:I(()=>[...s[2]||(s[2]=[x(" 保存配置 ",-1)])]),_:1},8,["disabled"])]),o.value?D((p(),_("div",ne,[b(y,{ref_key:"treeRef",ref:u,data:R.value,"show-checkbox":"","node-key":"id","default-expand-all":"",props:{label:"name"}},{default:I(({node:a,data:B})=>[h("span",le,[h("span",null,K(a.label),1),b(i,{size:"small",type:L(B.type),style:{"margin-left":"8px"}},{default:I(()=>[x(K(H(B.type)),1)]),_:2},1032,["type"])])]),_:1},8,["data"])])),[[n,c.value]]):(p(),_("div",oe,"请选择左侧用户进行权限配置"))])])}}});const de=X(ie,[["__scopeId","data-v-57d700d8"]]);export{de as default};
