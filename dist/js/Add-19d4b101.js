var C=(O,D,N)=>new Promise((F,w)=>{var V=c=>{try{v(N.next(c))}catch(o){w(o)}},y=c=>{try{v(N.throw(c))}catch(o){w(o)}},v=c=>c.done?F(c.value):Promise.resolve(c.value).then(V,y);v((N=N.apply(O,D)).next())});import{d as X,r as x,a as Z,k as I,l as ee,x as z,F as te,c as A,g as f,b as e,w as t,t as B,T as oe,G as le,e as ae,f as _,z as ne,o as k,h as q,B as ue,q as ie,H as se,I as de,J as re,E as P,_ as me}from"./index-0d744b35.js";import{f as E}from"./date-70ed563a.js";import{g as M}from"./index-1d5d4db3.js";import{O as ce}from"./OperationBar-ba9dfaef.js";import{T as pe}from"./TaxInvoiceUpload-5376d54e.js";import{u as be}from"./options-9fb748fa.js";const fe={class:"inbound-add"},ge={class:"page-header"},_e={class:"page-title"},he={class:"item-cards"},Ne={class:"item-card-header"},ve={class:"item-card-title"},Ve={class:"item-row-actions"},ye={class:"total-amount"},we=X({__name:"Add",setup(O){const D=le(),N=ae(),F=be(),w=x(),V=x(!1),y=x(""),v=x(!1),c=x(!1),o=Z({inboundDate:E(new Date),inboundNo:"",supplier:"",items:[]}),Y={inboundDate:[{required:!0,message:"请选择入库日期",trigger:"change"}],inboundNo:[{required:!0,message:"请输入货单编号",trigger:"blur"}],supplier:[{required:!0,message:"请输入供应商",trigger:"blur"}]},b=[{required:!0,message:"此项为必填项",trigger:["blur","change"]}],J=I(()=>(o.items||[]).reduce((l,u)=>l+Number((Number(u.weightKg||0)*Number(u.unitPrice||0)).toFixed(2)),0).toFixed(2)),j=I(()=>"80px"),K=I(()=>V.value&&y.value?`draft:inbound:edit:${y.value}`:"draft:inbound:add"),G=()=>{N.push("/inventory/in")},R=()=>{o.items.push({id:M(),productSpec:"",composition:"",weight:null,width:null,color:"",colorNo:"",batchNo:"",quantity:null,weightKg:null,unitPrice:null,amountEdited:!1,amount:null,taxAttachments:[]})},H=g=>{const l={id:M(),productSpec:"",composition:"",weight:null,width:null,color:"",colorNo:"",batchNo:"",quantity:null,weightKg:null,unitPrice:null,amountEdited:!1,amount:null,taxAttachments:[]};o.items.splice(g+1,0,l)},L=g=>{o.items.length!==1&&o.items.splice(g,1)},T=g=>{const l=o.items[g],u=Number(l.weightKg||0),s=Number(l.unitPrice||0);if(!l.amountEdited){const a=parseFloat((u*s).toFixed(2));l.amount=a>0?a:null}},W=()=>C(this,null,function*(){if(!(yield w.value.validate()))return;if(!o.items.length){P.error("请至少添加一条色布明细");return}for(const[u,s]of o.items.entries()){const a=["productSpec","composition","color","colorNo","batchNo"];for(const r of a)if(!s[r]){P.error(`第${u+1}行 ${r} 不能为空`);return}const d=["weight","width","quantity","weightKg","unitPrice"];for(const r of d){const p=s[r];if(p==null||Number.isNaN(Number(p))){P.error(`第${u+1}行 ${r} 需要有效数字`);return}}if(s.amount===null||s.amount===void 0||Number.isNaN(Number(s.amount))){const r=Number(s.weightKg||0),p=Number(s.unitPrice||0);s.amount=Number((r*p).toFixed(2))}}const l={batch:{inboundDate:o.inboundDate,inboundNo:o.inboundNo,supplier:o.supplier,operator:"admin"},items:o.items.map(u=>{var s;return{id:u.id,productSpec:u.productSpec,composition:u.composition,weight:Number(u.weight||0),width:Number(u.width||0),color:u.color,colorNo:u.colorNo,batchNo:u.batchNo,quantity:Number(u.quantity||0),weightKg:Number(u.weightKg||0),unitPrice:Number(u.unitPrice||0),amount:Number((s=u.amount)!=null?s:Number(u.weightKg||0)*Number(u.unitPrice||0)).toFixed(2)}})};c.value=!0,yield z.createInboundBatch(l).finally(()=>{c.value=!1}),P.success("新增成功"),F.invalidate(),localStorage.removeItem(K.value),N.push("/inventory/in")});return ee(()=>C(this,null,function*(){const g=D.query.edit==="1",l=D.query.id||"";if(g&&l){V.value=!0,y.value=l,v.value=!0;const s=yield z.getInboundBatchDetail(l);o.inboundDate=E(s.batch.inboundDate),o.inboundNo=s.batch.inboundNo,o.supplier=s.batch.supplier,o.items=(s.items||[]).map(a=>{var d,r,p,S,h,U,$;return{id:a.id,productSpec:((d=a.colorFabric)==null?void 0:d.productSpec)||"",composition:((r=a.colorFabric)==null?void 0:r.composition)||"",weight:Number(((p=a.colorFabric)==null?void 0:p.weight)||0),width:Number(((S=a.colorFabric)==null?void 0:S.width)||0),color:((h=a.colorFabric)==null?void 0:h.color)||"",colorNo:((U=a.colorFabric)==null?void 0:U.colorNo)||"",batchNo:(($=a.colorFabric)==null?void 0:$.batchNo)||"",quantity:Number(a.quantity||0),weightKg:Number(a.weightKg||0),unitPrice:Number(a.unitPrice||0),amount:Number(a.amount),taxAttachments:a.taxAttachments||[]}}),v.value=!1}else{V.value=!1,y.value="",localStorage.removeItem("draft:inbound:add"),o.inboundDate=E(new Date),o.inboundNo="",o.supplier="",o.items=[],R();return}const u=localStorage.getItem(K.value);u&&Object.assign(o,JSON.parse(u)),o.items.length||R()})),te(o,()=>{localStorage.setItem(K.value,JSON.stringify(o))},{deep:!0}),(g,l)=>{const u=_("el-button"),s=_("el-date-picker"),a=_("el-form-item"),d=_("el-col"),r=_("el-input"),p=_("el-row"),S=_("el-divider"),h=_("el-input-number"),U=_("el-card"),$=_("el-form"),Q=ne("loading");return k(),A("div",fe,[f("div",ge,[e(u,{class:"back-btn",onClick:G},{default:t(()=>[...l[3]||(l[3]=[q("返回",-1)])]),_:1}),f("h1",_e,B(V.value?"编辑入库":"新增入库"),1)]),e(oe,{name:"fade"},{default:t(()=>[f("div",{class:"content-scroll",style:re({paddingBottom:j.value})},[ue((k(),ie(U,null,{default:t(()=>[e($,{model:o,rules:Y,ref_key:"formRef",ref:w,"label-width":"100px"},{default:t(()=>[l[6]||(l[6]=f("h3",{class:"section-title"},"批次共用信息",-1)),e(p,{gutter:16},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"入库日期",prop:"inboundDate"},{default:t(()=>[e(s,{modelValue:o.inboundDate,"onUpdate:modelValue":l[0]||(l[0]=n=>o.inboundDate=n),type:"date","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"货单编号",prop:"inboundNo"},{default:t(()=>[e(r,{modelValue:o.inboundNo,"onUpdate:modelValue":l[1]||(l[1]=n=>o.inboundNo=n),placeholder:"请输入货单编号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(p,{gutter:16},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{label:"供应商",prop:"supplier"},{default:t(()=>[e(r,{modelValue:o.supplier,"onUpdate:modelValue":l[2]||(l[2]=n=>o.supplier=n),placeholder:"请输入或选择供应商"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(S),l[7]||(l[7]=f("h3",{class:"section-title"},"色布明细",-1)),f("div",he,[(k(!0),A(se,null,de(o.items,(n,m)=>(k(),A("div",{class:"item-row",key:n.id||m},[e(U,{class:"item-card",shadow:"hover"},{default:t(()=>[f("div",Ne,[f("div",ve,"色布明细 "+B(m+1),1)]),e(p,{gutter:12},{default:t(()=>[e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.productSpec`,rules:b,label:"品名规格"},{default:t(()=>[e(r,{modelValue:n.productSpec,"onUpdate:modelValue":i=>n.productSpec=i,placeholder:"品名规格"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.composition`,rules:b,label:"成分"},{default:t(()=>[e(r,{modelValue:n.composition,"onUpdate:modelValue":i=>n.composition=i,placeholder:"成分"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.weight`,rules:b,label:"克重(g/m²)"},{default:t(()=>[e(h,{modelValue:n.weight,"onUpdate:modelValue":i=>n.weight=i,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.width`,rules:b,label:"全幅宽(cm)"},{default:t(()=>[e(h,{modelValue:n.width,"onUpdate:modelValue":i=>n.width=i,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.color`,rules:b,label:"颜色"},{default:t(()=>[e(r,{modelValue:n.color,"onUpdate:modelValue":i=>n.color=i},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.colorNo`,rules:b,label:"色号"},{default:t(()=>[e(r,{modelValue:n.colorNo,"onUpdate:modelValue":i=>n.colorNo=i},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.batchNo`,rules:b,label:"缸号"},{default:t(()=>[e(r,{modelValue:n.batchNo,"onUpdate:modelValue":i=>n.batchNo=i},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.quantity`,rules:b,label:"匹数"},{default:t(()=>[e(h,{modelValue:n.quantity,"onUpdate:modelValue":i=>n.quantity=i,min:1,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.weightKg`,rules:b,label:"重量(kg)"},{default:t(()=>[e(h,{modelValue:n.weightKg,"onUpdate:modelValue":i=>n.weightKg=i,min:.01,precision:2,style:{width:"100%"},onChange:i=>T(m)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.unitPrice`,rules:b,label:"单价(元)"},{default:t(()=>[e(h,{modelValue:n.unitPrice,"onUpdate:modelValue":i=>n.unitPrice=i,min:.01,precision:2,style:{width:"100%"},onChange:i=>T(m)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:12},{default:t(()=>[e(a,{prop:`items.${m}.amount`,rules:b,label:"金额(元)"},{default:t(()=>[e(h,{modelValue:n.amount,"onUpdate:modelValue":i=>n.amount=i,min:.01,precision:2,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["prop"])]),_:2},1024),e(d,{xs:24,sm:24},{default:t(()=>[e(a,{label:"附件"},{default:t(()=>[e(pe,{"model-value":n.taxAttachments,"record-type":"inbound","record-id":n.id,"onUpdate:modelValue":i=>n.taxAttachments=i},null,8,["model-value","record-id","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),f("div",Ve,[e(u,{class:"card-action-btn",size:"small",type:"primary","aria-label":"在此卡片下方新增",onClick:i=>H(m)},{default:t(()=>[...l[4]||(l[4]=[q("新增",-1)])]),_:1},8,["onClick"]),e(u,{class:"card-action-btn",size:"small",type:"danger","aria-label":"删除该色布明细",disabled:o.items.length===1,onClick:i=>L(m)},{default:t(()=>[...l[5]||(l[5]=[q("删除",-1)])]),_:1},8,["disabled","onClick"])])]))),128))]),f("div",ye,"总金额：¥ "+B(J.value),1),l[8]||(l[8]=f("div",{class:"form-actions"},null,-1))]),_:1},8,["model"])]),_:1})),[[Q,v.value]])],4)]),_:1}),e(ce,{loading:c.value},{button:t(()=>[e(u,{type:"primary",loading:c.value,onClick:W},{default:t(()=>[...l[9]||(l[9]=[q("提交",-1)])]),_:1},8,["loading"])]),_:1},8,["loading"])])}}});const Pe=me(we,[["__scopeId","data-v-abd28b53"]]);export{Pe as default};
