var A=(Q,D,V)=>new Promise((C,F)=>{var w=l=>{try{k(V.next(l))}catch(U){F(U)}},$=l=>{try{k(V.throw(l))}catch(U){F(U)}},k=l=>l.done?C(l.value):Promise.resolve(l.value).then(w,$);k((V=V.apply(Q,D)).next())});import{d as Ne,r as E,k as Z,a as xe,l as ke,c as y,g as m,b as o,w as t,T as Ue,e as Se,x as ee,f,z as De,o as g,h as _,B as Ce,q as J,H as N,I as x,t as B,i as K,J as Fe,E as v,D as $e,_ as qe}from"./index-0d744b35.js";import{f as oe}from"./date-70ed563a.js";import{g as Ie}from"./index-1d5d4db3.js";import{O as Ae}from"./OperationBar-ba9dfaef.js";import{T as Ee}from"./TaxInvoiceUpload-5376d54e.js";import{R as Be}from"./index-468e0e38.js";import{u as Ke}from"./options-9fb748fa.js";const Pe={class:"outbound-add"},Re={class:"page-header"},Me={class:"item-cards"},Oe={class:"item-card-header"},Te={class:"item-card-title"},Ye={class:"color-field"},je={class:"item-row-actions"},ze={class:"detail-cards"},Je={class:"item-card-header"},Qe={class:"item-card-title"},We={class:"detail-rows"},Le={class:"grid-labels"},He={class:"grid-10"},Ge={class:"summary-bar"},Xe={class:"summary-info"},Ze={class:"summary-value"},eo={class:"summary-actions"},P="draft:outbound:add:batch",oo=Ne({__name:"Add",setup(Q){const D=Se(),V=Ke(),C=E(),F=E(!1),w=E(!1),$=()=>{D.back()},k=Z(()=>"80px"),l=xe({outboundDate:oe(new Date),outboundNo:"",code:"",customer:"",consignee:"",modules:[],detailSections:[]}),U=[{required:!0,message:"此项为必填项",trigger:["blur","change"]}],R=[{required:!0,trigger:["blur","change"],validator:(a,e,u)=>{if(e===null||e===""||e===void 0)return u(new Error("请输入有效数字"));const r=Number(e);if(Number.isNaN(r)||r<=0)return u(new Error("请输入有效数字"));u()}}],te=R,M=R,le={outboundDate:[{required:!0,message:"请选择出货日期",trigger:"change"}],outboundNo:[{required:!0,message:"请输入货单号",trigger:"blur"}],code:[{required:!0,message:"请输入编号",trigger:"blur"}],customer:[{required:!0,message:"请输入客户",trigger:"blur"}],consignee:[{required:!0,message:"请输入签收人",trigger:"blur"}]},S=E([]),O=()=>{const a={uid:b(),colorFabricId:"",composition:"",color:"",colorCard:"",craft:"",weight:null,customerNote:"",quantity:null,weightKg:null,unitPrice:null,amount:null,amountEdited:!1,amountDisplay:"",remark:"",taxAttachments:[]};l.modules.push(a),L(a.uid)},ae=a=>{const e={uid:b(),colorFabricId:"",composition:"",color:"",colorCard:"",craft:"",weight:null,customerNote:"",quantity:null,weightKg:null,unitPrice:null,amount:null,amountEdited:!1,amountDisplay:"",remark:"",taxAttachments:[]};l.modules.splice(a+1,0,e),L(e.uid,a+1)},ne=a=>{l.modules.splice(a,1),l.detailSections.splice(a,1),l.modules.length||O()},W=()=>{var a;l.detailSections.push({uid:b(),moduleUid:((a=l.modules[l.modules.length-1])==null?void 0:a.uid)||"",color:"",rows:[{uid:b(),cells:Array(10).fill("")}]})},L=(a,e)=>{const u={uid:b(),moduleUid:a,color:"",rows:[{uid:b(),cells:Array(10).fill("")}]};e!==void 0?l.detailSections.splice(e,0,u):l.detailSections.push(u)},ue=a=>{l.detailSections[a].rows.push({uid:b(),cells:Array(10).fill("")})},se=(a,e)=>{l.detailSections[a].rows.splice(e,1),l.detailSections[a].rows.length||ue(a)},de=(a,e)=>{l.detailSections[a].rows.splice(e+1,0,{uid:b(),cells:Array(10).fill("")})},re=a=>{const e=l.modules[a],u=S.value.find(r=>r.id===e.colorFabricId);u&&(e.composition=u.composition||"",e.color=u.color||"",e.weight=Number(u.weight||0),e.amountEdited=!1,e.amountDisplay="",e.quantity=null,e.weightKg=null,e.unitPrice=null,e.amount=null)},H=a=>{const e=l.modules[a],u=S.value.find(d=>d.id===e.colorFabricId),r=e.weight||(u==null?void 0:u.weight)||0;u&&e.quantity&&e.quantity>0&&(e.weightKg=parseFloat((e.quantity*r/1e3).toFixed(2)),T(a))},T=a=>{const e=l.modules[a];if(!e.amountEdited){const u=Number(e.weightKg||0),r=Number(e.unitPrice||0),d=parseFloat((u*r).toFixed(2));e.amount=d,e.amountDisplay=d?d.toFixed(2):""}},ie=a=>{const e=l.modules[a];e.amountEdited=!0;const u=Number(e.amountDisplay||0);e.amount=Number.isNaN(u)?0:u},ce=Z(()=>l.modules.reduce((e,u)=>e+Number(u.amount||0),0).toFixed(2)),me=()=>{localStorage.setItem(P,JSON.stringify(l)),v.success("草稿已保存")},pe=()=>A(this,null,function*(){try{yield $e.confirm("确定清除当前草稿并重置所有表单数据？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),localStorage.removeItem(P),Object.assign(l,{outboundDate:oe(new Date),outboundNo:"",code:"",customer:"",consignee:"",modules:[],detailSections:[]}),O(),W(),v.success("草稿已清除")}catch(a){}}),b=()=>Ie(),fe=()=>{if(l.detailSections=(l.detailSections||[]).map(a=>({uid:a.uid,moduleUid:a.moduleUid||"",color:a.color||"",rows:(a.rows||[]).map(e=>({uid:e.uid,cells:(e.cells||Array(10).fill("")).map(u=>u===0?"":u)}))})),l.detailSections.length!==l.modules.length){const a=[];l.modules.forEach((e,u)=>{const r=l.detailSections.find(d=>d.moduleUid===e.uid)||l.detailSections[u];r?a.push(r):a.push({uid:b(),moduleUid:e.uid,color:"",rows:[{uid:b(),cells:Array(10).fill("")}]})}),l.detailSections=a}},ge=()=>A(this,null,function*(){const a=yield ee.getStockList({});S.value=(a||[]).map(e=>{var u,r,d,i,c;return{id:(u=e.colorFabric)==null?void 0:u.id,productSpec:(r=e.colorFabric)==null?void 0:r.productSpec,composition:(d=e.colorFabric)==null?void 0:d.composition,color:(i=e.colorFabric)==null?void 0:i.color,weight:(c=e.colorFabric)==null?void 0:c.weight,currentStock:e.currentQuantity}})}),_e=()=>{if(!l.modules.length)return!1;for(const[a,e]of l.modules.entries()){if(!e.colorFabricId)return v.error(`第${a+1}个色布未选择品名规格`),!1;const u=S.value.find(d=>d.id===e.colorFabricId),r=["quantity","weightKg","unitPrice"];for(const d of r){const i=e[d];if(i==null||Number.isNaN(Number(i))||Number(i)<=0)return v.error(`第${a+1}个色布 ${d} 需要有效数字`),!1}if(u&&Number(e.quantity||0)>Number(u.currentStock||0))return v.error(`第${a+1}个色布出库匹数不能大于库存(${u.currentStock})`),!1}return!0},be=()=>A(this,null,function*(){if((yield C.value.validate())&&_e())try{w.value=!0;const e=r=>{const d=l.detailSections.find(c=>c.moduleUid===r);return d?(d.rows||[]).flatMap(c=>c.cells||[]).filter(c=>c!==""&&c!==null&&!Number.isNaN(Number(c))).map(c=>Number(c)):[]},u=l.modules.map(r=>{const d=e(r.uid),i=d.reduce((q,Y)=>q+Number(Y||0),0),c=d.length?Number(i.toFixed(2)):Number(r.weightKg||0),h=d.length?d.length:Number(r.quantity||0);return{id:r.uid,colorFabricId:r.colorFabricId,quantity:h,weightKg:c,unitPrice:Number(r.unitPrice||0),amount:Number(r.amountDisplay||r.amount||0).toFixed(2),outboundDetails:d,composition:r.composition,color:r.color,process:r.craft,gramWeight:r.weight,customerNote:r.customerNote,remark:r.remark}});yield ee.createOutboundBatch({common:{outboundDate:l.outboundDate,outboundNo:l.outboundNo,code:l.code,customer:l.customer,consignee:l.consignee},items:u}),localStorage.removeItem(P),v.success("批量出库成功"),V.invalidate(),D.push("/inventory/out")}catch(e){v.error((e==null?void 0:e.message)||"提交失败")}finally{w.value=!1}});return ke(()=>{ge(),l.modules.length||O(),l.detailSections.length||W();const a=localStorage.getItem(P);if(a)try{const e=JSON.parse(a);Object.assign(l,e)}catch(e){}fe()}),(a,e)=>{const u=f("el-button"),r=f("el-date-picker"),d=f("el-form-item"),i=f("el-col"),c=f("el-input"),h=f("el-row"),q=f("el-divider"),Y=f("el-option"),ye=f("el-select"),he=f("el-color-picker"),I=f("el-input-number"),j=f("el-card"),ve=f("el-form"),Ve=De("loading");return g(),y("div",Pe,[m("div",Re,[o(u,{class:"back-btn",onClick:$},{default:t(()=>[...e[5]||(e[5]=[_("返回",-1)])]),_:1}),e[6]||(e[6]=m("h1",{class:"page-title"},"新增出库",-1))]),o(Ue,{name:"fade"},{default:t(()=>[m("div",{class:"content-scroll",style:Fe({paddingBottom:k.value})},[Ce((g(),J(j,null,{default:t(()=>[o(ve,{model:l,rules:le,ref_key:"formRef",ref:C,"label-width":"100px"},{default:t(()=>[o(h,{gutter:16},{default:t(()=>[o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"出货日期",prop:"outboundDate"},{default:t(()=>[o(r,{modelValue:l.outboundDate,"onUpdate:modelValue":e[0]||(e[0]=s=>l.outboundDate=s),type:"date","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"货单号",prop:"outboundNo"},{default:t(()=>[o(c,{modelValue:l.outboundNo,"onUpdate:modelValue":e[1]||(e[1]=s=>l.outboundNo=s),placeholder:"请输入货单号"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(h,{gutter:16},{default:t(()=>[o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"编号",prop:"code"},{default:t(()=>[o(c,{modelValue:l.code,"onUpdate:modelValue":e[2]||(e[2]=s=>l.code=s),placeholder:"请输入编号"},null,8,["modelValue"])]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"客户",prop:"customer"},{default:t(()=>[o(Be,{modelValue:l.customer,"onUpdate:modelValue":e[3]||(e[3]=s=>l.customer=s),type:"customer","allow-create":!0,placeholder:"请输入客户"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"签收人",prop:"consignee"},{default:t(()=>[o(c,{modelValue:l.consignee,"onUpdate:modelValue":e[4]||(e[4]=s=>l.consignee=s),placeholder:"请输入签收人"},null,8,["modelValue"])]),_:1})]),_:1}),o(q,null,{default:t(()=>[...e[7]||(e[7]=[_("色布模块",-1)])]),_:1}),m("div",Me,[(g(!0),y(N,null,x(l.modules,(s,p)=>(g(),y("div",{class:"item-row",key:s.uid},[o(j,{class:"item-card",shadow:"hover"},{default:t(()=>[m("div",Oe,[m("div",Te,"色布 "+B(p+1),1)]),o(h,{gutter:12},{default:t(()=>[o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.colorFabricId`,rules:U,label:"品名规格"},{default:t(()=>[o(ye,{modelValue:s.colorFabricId,"onUpdate:modelValue":n=>s.colorFabricId=n,filterable:"",placeholder:"请选择品名规格",onChange:n=>re(p),style:{width:"100%"}},{default:t(()=>[(g(!0),y(N,null,x(S.value,n=>(g(),J(Y,{key:n.id,label:`${n.productSpec} (${n.currentStock}匹)`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"成分"},{default:t(()=>[o(c,{modelValue:s.composition,"onUpdate:modelValue":n=>s.composition=n},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"颜色"},{default:t(()=>[m("div",Ye,[o(c,{modelValue:s.color,"onUpdate:modelValue":n=>s.color=n,placeholder:"颜色名称"},null,8,["modelValue","onUpdate:modelValue"]),o(he,{modelValue:s.colorCard,"onUpdate:modelValue":n=>s.colorCard=n},null,8,["modelValue","onUpdate:modelValue"])])]),_:2},1024)]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"工艺"},{default:t(()=>[o(c,{modelValue:s.craft,"onUpdate:modelValue":n=>s.craft=n},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.weight`,rules:R,label:"克重(g/m²)"},{default:t(()=>[o(I,{modelValue:s.weight,"onUpdate:modelValue":n=>s.weight=n,min:1,precision:0,style:{width:"100%"},onChange:n=>H(p)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"客户备注"},{default:t(()=>[o(c,{modelValue:s.customerNote,"onUpdate:modelValue":n=>s.customerNote=n,type:"textarea",rows:2},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.quantity`,rules:K(te),label:"匹数"},{default:t(()=>[o(I,{modelValue:s.quantity,"onUpdate:modelValue":n=>s.quantity=n,min:1,precision:0,style:{width:"100%"},onChange:n=>H(p)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop","rules"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.weightKg`,rules:K(M),label:"重量(kg)"},{default:t(()=>[o(I,{modelValue:s.weightKg,"onUpdate:modelValue":n=>s.weightKg=n,min:.01,precision:2,style:{width:"100%"},onChange:n=>T(p)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop","rules"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.unitPrice`,rules:K(M),label:"单价(元)"},{default:t(()=>[o(I,{modelValue:s.unitPrice,"onUpdate:modelValue":n=>s.unitPrice=n,min:.01,precision:2,style:{width:"100%"},onChange:n=>T(p)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1032,["prop","rules"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{prop:`modules.${p}.amount`,rules:K(M),label:"金额(元)"},{default:t(()=>[o(c,{modelValue:s.amountDisplay,"onUpdate:modelValue":n=>s.amountDisplay=n,onInput:n=>ie(p)},{prefix:t(()=>[...e[8]||(e[8]=[_("¥",-1)])]),_:1},8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1032,["prop","rules"])]),_:2},1024),o(i,{xs:24,sm:12},{default:t(()=>[o(d,{label:"备注"},{default:t(()=>[o(c,{modelValue:s.remark,"onUpdate:modelValue":n=>s.remark=n,type:"textarea",rows:2},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),o(i,{xs:24,sm:24},{default:t(()=>[o(d,{label:"附件"},{default:t(()=>[o(Ee,{"model-value":s.taxAttachments,"record-type":"outbound","record-id":s.uid,"onUpdate:modelValue":n=>s.taxAttachments=n},null,8,["model-value","record-id","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),m("div",je,[o(u,{class:"card-action-btn",type:"primary",onClick:n=>ae(p)},{default:t(()=>[...e[9]||(e[9]=[_("新增",-1)])]),_:1},8,["onClick"]),o(u,{class:"card-action-btn",type:"danger",onClick:n=>ne(p)},{default:t(()=>[...e[10]||(e[10]=[_("删除",-1)])]),_:1},8,["onClick"])])]))),128))]),o(q,null,{default:t(()=>[...e[11]||(e[11]=[_("出库明细模块",-1)])]),_:1}),m("div",ze,[(g(!0),y(N,null,x(l.detailSections,(s,p)=>(g(),y("div",{class:"item-row",key:s.uid},[o(j,{class:"item-card",shadow:"hover"},{default:t(()=>[m("div",Je,[m("div",Qe,"明细模块 "+B(p+1),1)]),m("div",We,[o(h,{gutter:8,align:"middle"},{default:t(()=>[o(i,{xs:24,sm:3,style:{"margin-top":"28px"}},{default:t(()=>[o(c,{modelValue:s.color,"onUpdate:modelValue":n=>s.color=n,placeholder:"颜色",class:"detail-color-input"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(i,{xs:24,sm:21},{default:t(()=>[o(h,{gutter:8,align:"middle",style:{"margin-bottom":"8px"}},{default:t(()=>[o(i,{xs:24,sm:22},{default:t(()=>[m("div",Le,[(g(),y(N,null,x(10,n=>m("span",{key:n,class:"grid-label"},B(n),1)),64))])]),_:1}),o(i,{xs:24,sm:2})]),_:1}),(g(!0),y(N,null,x(s.rows,(n,G)=>(g(),y("div",{class:"detail-row",key:n.uid},[o(h,{gutter:8,align:"middle"},{default:t(()=>[o(i,{xs:24,sm:22},{default:t(()=>[m("div",He,[(g(!0),y(N,null,x(n.cells,(X,z)=>(g(),J(c,{key:z,modelValue:n.cells[z],"onUpdate:modelValue":we=>n.cells[z]=we,inputmode:"numeric",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"]))),128))])]),_:2},1024),o(i,{xs:24,sm:2,class:"row-actions"},{default:t(()=>[o(u,{class:"circle-btn",onClick:X=>de(p,G)},{default:t(()=>[...e[12]||(e[12]=[_("+",-1)])]),_:1},8,["onClick"]),o(u,{class:"circle-btn danger",onClick:X=>se(p,G)},{default:t(()=>[...e[13]||(e[13]=[_("-",-1)])]),_:1},8,["onClick"])]),_:2},1024)]),_:2},1024)]))),128))]),_:2},1024)]),_:2},1024)])]),_:2},1024)]))),128))]),m("div",Ge,[m("div",Xe,[e[14]||(e[14]=m("span",{class:"summary-label"},"总金额",-1)),m("span",Ze,"¥"+B(ce.value),1)]),m("div",eo,[o(Ae,{loading:w.value},{button:t(()=>[o(u,{onClick:$},{default:t(()=>[...e[15]||(e[15]=[_("返回",-1)])]),_:1}),o(u,{onClick:me},{default:t(()=>[...e[16]||(e[16]=[_("保存草稿",-1)])]),_:1}),o(u,{onClick:pe,type:"danger"},{default:t(()=>[...e[17]||(e[17]=[_("清除草稿",-1)])]),_:1}),o(u,{type:"primary",loading:w.value,onClick:be},{default:t(()=>[...e[18]||(e[18]=[_("提交",-1)])]),_:1},8,["loading"])]),_:1},8,["loading"])])])]),_:1},8,["model"])]),_:1})),[[Ve,F.value]])],4)]),_:1})])}}});const co=qe(oo,[["__scopeId","data-v-fa395d23"]]);export{co as default};
