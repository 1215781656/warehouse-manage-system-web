var v=(s,S,t)=>new Promise((i,l)=>{var e=n=>{try{u(t.next(n))}catch(y){l(y)}},f=n=>{try{u(t.throw(n))}catch(y){l(y)}},u=n=>n.done?i(n.value):Promise.resolve(n.value).then(e,f);u((t=t.apply(s,S)).next())});import{r as m,d as P,F as B,l as M,f as _,o as N,c as F,g as A,b as I,w as K,h as q,i as z,t as R,Q as V,P as k,E as T,_ as D}from"./index-df9e2be5.js";const J=s=>{var d;const S=(s==null?void 0:s.storageKey)||"ExportSelectionTableSelection",t=(s==null?void 0:s.rowKey)||"id",i=(d=s==null?void 0:s.debounceMs)!=null?d:200,l=m(new Set),e=m(!1),f=m(!1);let u=null;const n=()=>{u&&clearTimeout(u),u=setTimeout(()=>{f.value=!0;const c={allSelected:e.value,ids:Array.from(l.value),ts:Date.now()};localStorage.setItem(S,JSON.stringify(c)),f.value=!1},i)};return{selectedSet:l,allSelected:e,saving:f,restore:()=>{const c=localStorage.getItem(S);if(c)try{const a=JSON.parse(c);e.value=!!a.allSelected,l.value=new Set(a.ids||[])}catch(a){}},persist:n,selectId:c=>{e.value||(l.value.add(c),l.value=new Set(l.value),n())},deselectId:c=>{e.value||(l.value.delete(c),l.value=new Set(l.value),n())},setPageSelections:(c,a)=>{if(!e.value){for(const h of c){const g=h[t];a?l.value.add(g):l.value.delete(g)}l.value=new Set(l.value),n()}},getSelectedIds:()=>Array.from(l.value),toggleAll:(c,a)=>v(void 0,null,function*(){if(!c){l.value.clear(),l.value=new Set,e.value=!1,n();return}if(!(s!=null&&s.fetchAllIds)){e.value=!1,n();return}const h=yield s.fetchAllIds(a);l.value=new Set(h||[]),e.value=!0,n()}),clear:()=>{l.value.clear(),l.value=new Set,e.value=!1,localStorage.removeItem(S)}}},O={class:"export-selection-table"},Q={class:"toolbar"},$=P({__name:"ExportSelectionTable",props:{dataSource:{},selectionType:{},onSelectionChange:{type:Function},storageKey:{},rowKey:{},fetchAllIds:{type:Function},fetchItemsByIds:{type:Function},queryParams:{}},setup(s,{expose:S}){const t=s,i=m(),l=m(!1),e=J({storageKey:t.storageKey,rowKey:t.rowKey,fetchAllIds:t.fetchAllIds}),f=(o,r)=>!e.allSelected.value,u=()=>v(this,null,function*(){if(!i.value)return;l.value=!0;const o=e.selectedSet.value,r=t.rowKey||"id";for(const d of t.dataSource||[]){const c=d[r],a=o.has(c);i.value.toggleRowSelection(d,a)}yield k(),l.value=!1}),n=o=>{if(l.value||e.allSelected.value)return;const r=t.rowKey||"id",d=o.map(a=>a[r]),c=(t.dataSource||[]).map(a=>a[r]);for(const a of c)d.includes(a)?e.selectId(a):e.deselectId(a);t.onSelectionChange&&t.onSelectionChange(e.getSelectedIds())},y=()=>v(this,null,function*(){const o=!e.allSelected.value;try{yield e.toggleAll(o,t.queryParams),t.onSelectionChange&&t.onSelectionChange(e.getSelectedIds())}catch(r){T.error("全选失败")}}),b=o=>v(this,null,function*(){try{o?yield e.toggleAll(!0,t.queryParams):w(),u(),t.onSelectionChange&&t.onSelectionChange(e.getSelectedIds())}catch(r){T.error("全选失败")}}),w=()=>{e.clear(),i.value&&i.value.clearSelection(),t.onSelectionChange&&t.onSelectionChange([])},C=()=>v(this,null,function*(){const o=e.getSelectedIds();if(e.allSelected.value&&t.fetchItemsByIds){const h=[];for(let g=0;g<o.length;g+=500){const E=o.slice(g,g+500),x=yield t.fetchItemsByIds(E);Array.isArray(x)&&h.push(...x)}return h}const r=t.rowKey||"id",d=new Map;for(const a of t.dataSource||[])d.set(a[r],a);const c=[];for(const a of o)d.has(a)&&c.push(d.get(a));return c});B(()=>t.dataSource,()=>v(this,null,function*(){l.value=!0,yield k(),yield u()}));const p=()=>e.getSelectedIds().length;return M(()=>{e.restore(),u()}),S({getSelectedItems:C,clearSelection:w,toggleAllSelection:y,isAllSelected:()=>e.allSelected.value}),(o,r)=>{const d=_("el-checkbox"),c=_("el-table-column"),a=_("el-table");return N(),F("div",O,[A("div",Q,[I(d,{"model-value":z(e).allSelected.value,disabled:s.selectionType!=="all",onChange:b},{default:K(()=>[...r[0]||(r[0]=[q("全选",-1)])]),_:1},8,["model-value","disabled"]),A("span",null,"已选："+R(p()),1)]),I(a,{ref_key:"tableRef",ref:i,data:s.dataSource,style:{width:"100%"},onSelectionChange:n},{default:K(()=>[I(c,{type:"selection",width:"50",selectable:f}),V(o.$slots,"columns",{},void 0,!0)]),_:3},8,["data"])])}}});const H=D($,[["__scopeId","data-v-277a17aa"]]);export{H as E};
