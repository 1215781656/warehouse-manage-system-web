var z=(X,V,o)=>new Promise((j,U)=>{var k=_=>{try{w(o.next(_))}catch(I){U(I)}},E=_=>{try{w(o.throw(_))}catch(I){U(I)}},w=_=>_.done?j(_.value):Promise.resolve(_.value).then(k,E);w((o=o.apply(X,V)).next())});import{d as ye,u as he,a as M,r as S,l as Ae,c as we,g as s,i as G,q as $,w as n,v as Y,b as t,t as h,e as xe,L as H,E as D,y as Re,f as m,z as Se,o as O,h as A,A as De,s as Pe,B as ke,n as Ie,C as ze,M as W,D as Ve,_ as Ce}from"./index-df9e2be5.js";import{R as Ue}from"./ResponsiveActions-187abf65.js";import{T as Te}from"./TaxInvoiceUpload-5d5a3401.js";import{G as Oe}from"./GeneralFileUpload-45921d0a.js";import{E as Ee}from"./ExportSelectionTable-6f9431bb.js";const Fe={class:"payable"},Ne={class:"page-header"},Be={class:"header-actions"},Le={class:"data-card"},Me={class:"data-card-value"},$e={class:"data-card"},je={class:"data-card-value"},Ke={class:"data-card-trend"},Ge={class:"trend-up"},Ye={class:"data-card"},He={class:"data-card-value",style:{color:"#ff4d4f"}},Je={class:"data-card-trend"},Qe={class:"pagination-container"},We={class:"dialog-footer"},Xe={class:"summary-bar"},Ze={class:"summary-bar__items"},qe={class:"summary-bar__item"},et={class:"summary-bar__value"},tt={class:"summary-bar__item"},at={class:"summary-bar__value"},lt={class:"summary-bar__item"},nt={class:"summary-bar__value summary-bar__value--danger"},ot=ye({__name:"index",setup(X){const V=he(),o=M({customer:"",dateRange:[]}),j=S([]),U=S(!1);S([]);let k=[];const E=S(),w=S(!1),_=S(0),I=S(!1),x=M({currentPage:1,pageSize:10,total:0}),g=M({totalPayable:0,totalPaid:0,totalUnpaid:0,paidPercent:0,unpaidPercent:0}),p=M({totalPayable:0,totalPaid:0,totalUnpaid:0,paidPercent:0,unpaidPercent:0}),F=S(!1),R=S(null),Z=S(),J=xe(),u=M({amount:null,remark:"",taxInvoiceAmount:null,taxAttachments:[],otherAttachments:[]}),ae={amount:[{required:!0,message:"请输入付款金额",trigger:"blur"}]},f=a=>a.toLocaleString("zh-CN",{minimumFractionDigits:2}),q=()=>{C()},le=()=>{o.customer="",o.dateRange=[],C()},C=()=>z(this,null,function*(){var a,e;U.value=!0;try{const i={page:x.currentPage,pageSize:x.pageSize,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(new Date(o.dateRange[0]).getTime()-new Date(o.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(new Date(o.dateRange[1]).getTime()-new Date(o.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},d=yield H().fetchPayableList(i),c=(d==null?void 0:d.list)||[],P=(d==null?void 0:d.total)||0;j.value=c,x.total=P;const v=((a=d==null?void 0:d.summary)==null?void 0:a.payable)||{};g.totalPayable=v.totalPayable||0,g.totalPaid=v.totalPaid||0,g.totalUnpaid=v.totalUnpaid||0,g.paidPercent=g.totalPayable?Number((g.totalPaid/g.totalPayable*100).toFixed(1)):0,g.unpaidPercent=g.totalPayable?Number((g.totalUnpaid/g.totalPayable*100).toFixed(1)):0;const r=((e=d==null?void 0:d.globalSummary)==null?void 0:e.payable)||{};r&&Object.keys(r).length&&(p.totalPayable=r.totalPayable||0,p.totalPaid=r.totalPaid||0,p.totalUnpaid=r.totalUnpaid||0,p.paidPercent=p.totalPayable?Number((p.totalPaid/p.totalPayable*100).toFixed(1)):0,p.unpaidPercent=p.totalPayable?Number((p.totalUnpaid/p.totalPayable*100).toFixed(1)):0)}catch(i){D.error("加载数据失败")}finally{U.value=!1}}),ne=a=>{x.pageSize=a,C()},oe=a=>{x.currentPage=a,C()},se=a=>z(this,null,function*(){R.value=a;try{const e=yield W.getPayableDetail(a.id);if(((e==null?void 0:e.unpaidAmount)||0)<=0){D.warning("该记录已全部付款，无需再次付款");return}u.amount=e==null?void 0:e.unpaidAmount,u.remark="",u.taxInvoiceAmount=e==null?void 0:e.taxInvoiceAmount,u.taxAttachments=(e==null?void 0:e.taxAttachments)||[],u.otherAttachments=(e==null?void 0:e.otherAttachments)||[],F.value=!0}catch(e){D.error("获取详情失败")}}),de=()=>{J.push("/finance/payable/add")},ie=()=>{Z.value.validate(a=>{a&&z(this,null,function*(){try{yield W.updatePayable(R.value.id,{paidAmount:Number(R.value.paidAmount||0)+Number(u.amount||0),taxInvoiceAmount:u.taxInvoiceAmount,remark:u.remark||void 0}),D.success(`付款成功：¥${f(u.amount)}`),F.value=!1,C()}catch(e){D.error("付款提交失败")}})})},re=a=>{J.push(`/finance/payable/edit/${a.id}`)},ue=a=>{Ve.confirm("确定要删除该记录吗？该操作为软删除。","删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>z(this,null,function*(){try{yield W.updatePayable(a.id,{deletedAt:new Date().toISOString()}),H().logOperation("payable","soft_delete",a.id),D.success("删除成功"),C()}catch(e){D.error("删除失败")}}))},ce=a=>!a.source||a.source==="manual",pe=a=>{const e=[];return e.push({label:"详情",onClick:()=>J.push(`/finance/payable/detail/${a.id}`)}),V.can(i=>i.Finance.Payable.Payment)&&e.push({label:"付款",onClick:()=>se(a)}),ce(a)&&(V.can(i=>i.Finance.Payable.Edit)&&e.push({label:"编辑",onClick:()=>re(a)}),V.can(i=>i.Finance.Payable.Delete)&&e.push({label:"删除",onClick:()=>ue(a),danger:!0})),e},me=()=>z(this,null,function*(){var a,e,i;if(!k||k.length===0){D.warning("请勾选数据");return}I.value=!1,w.value=!0,_.value=5;try{const b=(e=(a=E.value)==null?void 0:a.isAllSelected)!=null&&e.call(a)?"Y":"N",d={ids:b==="Y"?null:k,isAll:b,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(o.dateRange[0]).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(o.dateRange[1]).toISOString().substring(0,10):void 0},c=yield Re.exportReport("payable",d,T=>{if(T&&typeof T.loaded=="number"){const B=T.total||0;if(B>0){const K=Math.min(90,Math.max(10,Math.floor(T.loaded/B*90)));_.value=K}}}),P=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),v=URL.createObjectURL(P),r=document.createElement("a");r.href=v,r.download="应付导出.xlsx",r.click(),URL.revokeObjectURL(v),_.value=100,(i=E.value)==null||i.clearSelection(),D.success("导出成功")}catch(b){I.value=!0,D.error("导出失败")}finally{w.value=!1,setTimeout(()=>{_.value=0,I.value=!1},400)}}),N=new Map;let Q=null;const ge=a=>z(this,null,function*(){const e={page:1,pageSize:1e5,customer:(a==null?void 0:a.customer)||void 0,startDate:Array.isArray(a==null?void 0:a.dateRange)&&(a!=null&&a.dateRange[0])?new Date(new Date(a.dateRange[0]).getTime()-new Date(a.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(a==null?void 0:a.dateRange)&&(a!=null&&a.dateRange[1])?new Date(new Date(a.dateRange[1]).getTime()-new Date(a.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},b=yield H().fetchPayableList(e),d=(b==null?void 0:b.list)||[];Q=d,N.clear();for(const c of d)N.set(c.id,c);return d.map(c=>c.id)}),fe=a=>z(this,null,function*(){if(!Q){const i={page:1,pageSize:1e5,customer:o.customer||void 0,startDate:Array.isArray(o.dateRange)&&o.dateRange[0]?new Date(new Date(o.dateRange[0]).getTime()-new Date(o.dateRange[0]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,endDate:Array.isArray(o.dateRange)&&o.dateRange[1]?new Date(new Date(o.dateRange[1]).getTime()-new Date(o.dateRange[1]).getTimezoneOffset()*6e4).toISOString().substring(0,10):void 0,cache:!1},d=yield H().fetchPayableList(i),c=(d==null?void 0:d.list)||[];Q=c,N.clear();for(const P of c)N.set(P.id,P)}const e=[];for(const i of a){const b=N.get(i);b&&e.push(b)}return e});return Ae(()=>{C()}),(a,e)=>{const i=m("el-button"),b=m("el-progress"),d=m("el-icon"),c=m("el-col"),P=m("el-row"),v=m("el-input"),r=m("el-form-item"),T=m("el-date-picker"),B=m("el-form"),K=m("el-card"),y=m("el-table-column"),be=m("el-pagination"),ee=m("el-divider"),te=m("el-input-number"),_e=m("el-dialog"),ve=Se("loading");return O(),we("div",Fe,[s("div",Ne,[e[12]||(e[12]=s("h1",{class:"page-title"},"应付管理",-1)),s("div",Be,[G(V).can(l=>l.Finance.Payable.Add)?(O(),$(i,{key:0,type:"primary",onClick:de},{default:n(()=>[...e[11]||(e[11]=[A(" 新增 ",-1)])]),_:1})):Y("",!0),w.value?(O(),$(b,{key:1,percentage:_.value,status:I.value?"exception":void 0,style:{width:"160px"}},null,8,["percentage","status"])):Y("",!0),G(V).can(l=>l.Finance.Payable.Export)?(O(),$(i,{key:2,onClick:me,loading:w.value,disabled:w.value,type:"primary"},{default:n(()=>[w.value?Y("",!0):(O(),$(d,{key:0},{default:n(()=>[t(G(De))]),_:1})),A(" "+h(w.value?"导出中...":"导出"),1)]),_:1},8,["loading","disabled"])):Y("",!0)])]),t(P,{gutter:16,class:"mb-4"},{default:n(()=>[t(c,{span:8},{default:n(()=>[s("div",Le,[e[13]||(e[13]=s("div",{class:"data-card-title"},"应付总额",-1)),s("div",Me,"¥"+h(f(p.totalPayable)),1),e[14]||(e[14]=s("div",{class:"data-card-trend"},[s("span",{class:"trend-stable"},"来自全部数据")],-1))])]),_:1}),t(c,{span:8},{default:n(()=>[s("div",$e,[e[16]||(e[16]=s("div",{class:"data-card-title"},"已付金额",-1)),s("div",je,"¥"+h(f(p.totalPaid)),1),s("div",Ke,[s("span",Ge,"↑ "+h(p.paidPercent)+"%",1),e[15]||(e[15]=A(" 付款率 ",-1))])])]),_:1}),t(c,{span:8},{default:n(()=>[s("div",Ye,[e[18]||(e[18]=s("div",{class:"data-card-title"},"未付金额",-1)),s("div",He,"¥"+h(f(p.totalUnpaid)),1),s("div",Je,[e[17]||(e[17]=s("span",{class:"trend-danger"},"●",-1)),A(" 占比 "+h(p.unpaidPercent)+"% ",1)])])]),_:1})]),_:1}),t(K,{class:"search-card mb-4 search-bar"},{default:n(()=>[t(B,{inline:!0,model:o,class:"search-form"},{default:n(()=>[t(r,{label:"客户"},{default:n(()=>[t(v,{modelValue:o.customer,"onUpdate:modelValue":e[0]||(e[0]=l=>o.customer=l),placeholder:"请输入客户名称",size:"small"},null,8,["modelValue"])]),_:1}),t(r,{label:"日期"},{default:n(()=>[t(T,{modelValue:o.dateRange,"onUpdate:modelValue":e[1]||(e[1]=l=>o.dateRange=l),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期",size:"small",onChange:q},null,8,["modelValue"])]),_:1}),t(r,null,{default:n(()=>[t(i,{type:"primary",onClick:q,size:"small"},{default:n(()=>[t(d,null,{default:n(()=>[t(G(Pe))]),_:1}),e[19]||(e[19]=A(" 搜索 ",-1))]),_:1}),t(i,{onClick:le,size:"small"},{default:n(()=>[...e[20]||(e[20]=[A("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),t(K,null,{default:n(()=>[ke((O(),$(Ee,{ref_key:"exportTableRef",ref:E,dataSource:j.value,selectionType:"all",onSelectionChange:l=>ze(k)?k.value=l:k=l,rowKey:"id",storageKey:"payable-export-selection",queryParams:o,fetchAllIds:ge,fetchItemsByIds:fe},{columns:n(()=>[t(y,{prop:"inboundDate",label:"入库日期",width:"120"}),t(y,{prop:"inboundNo",label:"货单编号",width:"150"}),t(y,{prop:"supplier",label:"客户",width:"120"}),t(y,{prop:"productSpec",label:"品名规格","min-width":"150"}),t(y,{prop:"quantity",label:"匹数",width:"80"}),t(y,{prop:"weightKg",label:"重量(kg)",width:"100"}),t(y,{prop:"unitPrice",label:"单价(元)",width:"100"}),t(y,{prop:"payableAmount",label:"应付金额(元)",width:"120"},{default:n(({row:l})=>[A(" ¥"+h(f(l.payableAmount)),1)]),_:1}),t(y,{prop:"paidAmount",label:"已付金额(元)",width:"120"},{default:n(({row:l})=>[A(" ¥"+h(f(l.paidAmount)),1)]),_:1}),t(y,{prop:"taxInvoiceAmount",label:"税票金额(元)",width:"120"},{default:n(({row:l})=>[A(" ¥"+h(f(l.taxInvoiceAmount||0)),1)]),_:1}),t(y,{prop:"unpaidAmount",label:"未付金额(元)",width:"120"},{default:n(({row:l})=>[s("span",{class:Ie({"text-danger":l.unpaidAmount>0})}," ¥"+h(f(l.unpaidAmount)),3)]),_:1}),t(y,{prop:"remark",label:"备注","min-width":"120","show-overflow-tooltip":""}),t(y,{label:"操作",width:"200",fixed:"right"},{default:n(({row:l})=>[t(Ue,{items:pe(l)},null,8,["items"])]),_:1})]),_:1},8,["dataSource","onSelectionChange","queryParams"])),[[ve,U.value]]),s("div",Qe,[t(be,{"current-page":x.currentPage,"onUpdate:currentPage":e[2]||(e[2]=l=>x.currentPage=l),"page-size":x.pageSize,"onUpdate:pageSize":e[3]||(e[3]=l=>x.pageSize=l),"page-sizes":[10,20,50,100],total:x.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ne,onCurrentChange:oe},null,8,["current-page","page-size","total"])])]),_:1}),t(_e,{modelValue:F.value,"onUpdate:modelValue":e[10]||(e[10]=l=>F.value=l),title:"付款登记",width:"1000px"},{footer:n(()=>[s("span",We,[t(i,{onClick:e[9]||(e[9]=l=>F.value=!1)},{default:n(()=>[...e[23]||(e[23]=[A("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:ie},{default:n(()=>[...e[24]||(e[24]=[A("确定",-1)])]),_:1})])]),default:n(()=>[t(B,{model:u,rules:ae,ref_key:"payFormRef",ref:Z,"label-width":"100px"},{default:n(()=>[t(P,{gutter:24},{default:n(()=>[t(c,{span:12},{default:n(()=>[t(ee,{"content-position":"left"},{default:n(()=>[...e[21]||(e[21]=[A("基础信息",-1)])]),_:1}),t(r,{label:"供应商"},{default:n(()=>{var l;return[t(v,{value:(l=R.value)==null?void 0:l.supplier,disabled:""},null,8,["value"])]}),_:1}),t(r,{label:"应付金额"},{default:n(()=>{var l;return[t(v,{value:`¥${f(((l=R.value)==null?void 0:l.payableAmount)||0)}`,disabled:""},null,8,["value"])]}),_:1}),t(r,{label:"已付金额"},{default:n(()=>{var l;return[t(v,{value:`¥${f(((l=R.value)==null?void 0:l.paidAmount)||0)}`,disabled:""},null,8,["value"])]}),_:1}),t(r,{label:"未付金额"},{default:n(()=>{var l;return[t(v,{value:`¥${f(((l=R.value)==null?void 0:l.unpaidAmount)||0)}`,disabled:"",style:{color:"#ff4d4f"}},null,8,["value"])]}),_:1}),t(r,{label:"本次付款",prop:"amount"},{default:n(()=>{var l;return[t(te,{modelValue:u.amount,"onUpdate:modelValue":e[4]||(e[4]=L=>u.amount=L),min:.01,max:((l=R.value)==null?void 0:l.unpaidAmount)||0,precision:2,style:{width:"100%"}},null,8,["modelValue","max"])]}),_:1}),t(r,{label:"备注",prop:"remark"},{default:n(()=>[t(v,{modelValue:u.remark,"onUpdate:modelValue":e[5]||(e[5]=l=>u.remark=l),type:"textarea",rows:3,placeholder:"请输入备注信息"},null,8,["modelValue"])]),_:1})]),_:1}),t(c,{span:12},{default:n(()=>[t(ee,{"content-position":"left"},{default:n(()=>[...e[22]||(e[22]=[A("税务与附件",-1)])]),_:1}),t(r,{label:"税票金额",prop:"taxInvoiceAmount"},{default:n(()=>[t(te,{modelValue:u.taxInvoiceAmount,"onUpdate:modelValue":e[6]||(e[6]=l=>u.taxInvoiceAmount=l),min:0,precision:2,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(r,{label:"税票附件"},{default:n(()=>{var l;return[t(Te,{modelValue:u.taxAttachments,"onUpdate:modelValue":e[7]||(e[7]=L=>u.taxAttachments=L),"record-type":"payable","record-id":(l=R.value)==null?void 0:l.id},null,8,["modelValue","record-id"])]}),_:1}),t(r,{label:"其他附件"},{default:n(()=>{var l;return[t(Oe,{modelValue:u.otherAttachments,"onUpdate:modelValue":e[8]||(e[8]=L=>u.otherAttachments=L),"record-type":"payable","record-id":(l=R.value)==null?void 0:l.id},null,8,["modelValue","record-id"])]}),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),s("div",Xe,[e[28]||(e[28]=s("div",{class:"summary-bar__meta"},[s("span",{class:"summary-bar__meta-dot"}),s("span",{class:"summary-bar__meta-text"},"汇总（来自搜索数据）")],-1)),s("div",Ze,[s("div",qe,[e[25]||(e[25]=s("span",{class:"summary-bar__label"},"应付总额",-1)),s("span",et,"¥"+h(f(g.totalPayable)),1)]),s("div",tt,[e[26]||(e[26]=s("span",{class:"summary-bar__label"},"已付金额",-1)),s("span",at,"¥"+h(f(g.totalPaid)),1)]),s("div",lt,[e[27]||(e[27]=s("span",{class:"summary-bar__label"},"未付金额",-1)),s("span",nt,"¥"+h(f(g.totalUnpaid)),1)])])])])}}});const pt=Ce(ot,[["__scopeId","data-v-3fe3301d"]]);export{pt as default};
