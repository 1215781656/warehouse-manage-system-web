version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: warehouse_mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root_password_please_change
      # Database and User creation is handled by mounted scripts in /docker-entrypoint-initdb.d
    volumes:
      - ./server/sql:/docker-entrypoint-initdb.d
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306" # Exposed for debugging, can remove in production
    networks:
      - warehouse_net

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: warehouse_backend
    restart: always
    ports:
      - "3001:3001"
    environment:
      - PORT=3001
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=fabric_app
      - DB_PASS=123456
      - DB_NAME=fabric_db
      # Ensure JWT_SECRET matches your local .env or set a new one here
      - JWT_SECRET=${JWT_SECRET:-default_secret_please_change}
    depends_on:
      - mysql
    volumes:
      - ./server/server_uploads:/app/server_uploads
    networks:
      - warehouse_net

  frontend:
    image: nginx:alpine
    container_name: warehouse_frontend
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    networks:
      - warehouse_net

volumes:
  mysql_data:

networks:
  warehouse_net:
    driver: bridge
